<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DFLT | Final QA Analytics Deck</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-primary: #f8fafc; --bg-secondary: #ffffff; --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a; --text-secondary: #64748b; --border-color: #e2e8f0;
            --brand-color: #4f46e5; --brand-light: #eef2ff; --brand-dark: #3730a3;
            --green: #10b981; --orange: #f59e0b; --red: #ef4444;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --transition-speed: 0.3s;
        }
        html.dark {
            --bg-primary: #020617; --bg-secondary: #0f172a; --bg-tertiary: #1e293b;
            --text-primary: #f8fafc; --text-secondary: #94a3b8; --border-color: #334155;
            --brand-light: #1e293b;
        }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--bg-primary);
            color: var(--text-primary); transition: background-color var(--transition-speed), color var(--transition-speed);
        }
        /* Page Layout */
        #app-container { display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #app-header { z-index: 30; background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color); box-shadow: var(--shadow-md); }
        #app-main { flex-grow: 1; overflow-y: auto; padding: 1.5rem; }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid; grid-template-columns: repeat(12, 1fr);
            gap: 1.5rem; animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background-color: var(--bg-secondary); border-radius: 1.25rem;
            border: 1px solid var(--border-color); padding: 1.5rem;
            display: flex; flex-direction: column; box-shadow: var(--shadow-sm);
            transition: all var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card:hover { box-shadow: var(--shadow-md); transform: translateY(-4px); }
        .card-header { display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.75rem; }

        /* Component Styles */
        .kpi-value { font-weight: 800; color: var(--text-primary); margin-top: 0.25rem; }
        .table-container { flex-grow: 1; overflow-y: auto; min-height: 0; }
        .table-container thead { background-color: var(--bg-tertiary); position: sticky; top: 0; z-index: 10; }
        .table-container tbody tr { transition: background-color 0.2s; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .table-container tbody tr:hover { background-color: var(--brand-light); }
        .chart-container { flex-grow: 1; position: relative; min-height: 150px; }
        canvas { position: absolute; top: 0; left: 0; width: 100% !important; height: 100% !important; }

        /* Grid Placement */
        .kpi { grid-column: span 3; }
        .map-card { grid-column: 1 / 8; grid-row: 2 / span 2; }
        .trainer-leaderboard { grid-column: 8 / -1; grid-row: 2; }
        .observer-leaderboard { grid-column: 8 / -1; grid-row: 3; }
        .time-series { grid-column: 1 / 8; grid-row: 4; }
        .score-analysis { grid-column: 8 / -1; grid-row: 4; }
        
        @media screen and (max-width: 1280px) {
            .map-card { grid-column: 1 / -1; grid-row: 3 / span 2; min-height: 400px; }
            .trainer-leaderboard, .observer-leaderboard { grid-column: span 6; grid-row: 5; }
            .time-series { grid-column: 1 / -1; grid-row: 6; min-height: 350px; }
            .score-analysis { grid-column: 1 / -1; grid-row: 7; min-height: 350px; }
        }
        @media screen and (max-width: 1024px) { .kpi { grid-column: span 6; } }

        /* Auth & Loading Overlays */
        .overlay { position: fixed; inset: 0; z-index: 9999; display: flex; align-items: center; justify-content: center; background-color: var(--bg-primary); transition: opacity 0.5s ease-out; }
        .auth-box { background-color: var(--bg-secondary); padding: 2.5rem; border-radius: 1.5rem; box-shadow: var(--shadow-lg); text-align: center; }
        #loading-overlay { z-index: 50; background-color: rgba(255, 255, 255, 0.5); opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        html.dark #loading-overlay { background-color: rgba(2, 6, 23, 0.7); }
        #loading-overlay.visible { opacity: 1; pointer-events: auto; }
        
        .empty-state { flex-grow: 1; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); }
    </style>
</head>
<body class="invisible">

    <div id="password-overlay" class="overlay">
        <div class="auth-box flex flex-col items-center gap-4 w-full max-w-sm">
            <img src="https://www.sdpi.org/assets/images/sdpi-logo-2020.webp" alt="Logo" class="h-16">
            <h2 class="text-2xl font-bold">QA Analytics Deck</h2>
            <p class="text-sm text-gray-500">Enter password to access.</p>
            <input type="password" id="passwordInput" placeholder="••••••••" class="text-center p-2 border rounded-lg w-full focus:ring-2 focus:ring-indigo-500 focus:outline-none bg-transparent" />
            <button id="submitPassword" class="bg-indigo-600 text-white font-bold py-2 px-8 rounded-full w-full hover:bg-indigo-700 transition-colors">Access</button>
        </div>
    </div>

    <div id="app-container" style="display: none;">
        <header id="app-header" class="p-4 flex flex-wrap items-center justify-between gap-4">
            <div>
                <h1 class="text-2xl font-extrabold">DFLT QA Analytics</h1>
                <p id="lastUpdated" class="text-sm text-secondary">Loading...</p>
            </div>
            <div class="flex items-center gap-3 flex-wrap">
                <select id="provinceFilter" class="w-40 bg-tertiary border-tertiary rounded-md p-2 text-sm font-semibold"></select>
                <select id="trainerFilter" class="w-40 bg-tertiary border-tertiary rounded-md p-2 text-sm font-semibold"></select>
                <select id="observerFilter" class="w-40 bg-tertiary border-tertiary rounded-md p-2 text-sm font-semibold"></select>
                <button id="resetFilters" class="p-2 bg-tertiary hover:bg-border-color rounded-md font-bold" title="Reset Filters">✕</button>
                <button id="theme-toggle" class="p-2 bg-tertiary hover:bg-border-color rounded-md"></button>
            </div>
        </header>

        <main id="app-main">
            <div class="dashboard-grid">
                <section class="card kpi"><div class="card-header">Total Monitored</div><p id="totalSessions" class="kpi-value text-5xl text-brand-color">0</p></section>
                <section class="card kpi"><div class="card-header">Overall Avg Score</div><p id="overallScore" class="kpi-value text-5xl text-green">0%</p><p id="scoreTrend" class="text-sm text-center font-semibold mt-2"></p></section>
                <section class="card kpi"><div class="card-header">Top Strengths</div><div id="topStrengths" class="mt-2 space-y-2 flex-grow"></div></section>
                <section class="card kpi"><div class="card-header">Improvement Areas</div><div id="improvementAreas" class="mt-2 space-y-2 flex-grow"></div></section>
                
                <section class="card map-card !p-0"><div id="map" class="h-full w-full rounded-2xl z-0"></div></section>
                <section class="card trainer-leaderboard"><h3 class="font-bold text-lg">Trainer Performance</h3><div id="trainer-table-wrapper" class="table-container mt-2"></div></section>
                <section class="card observer-leaderboard"><h3 class="font-bold text-lg">Observer Activity</h3><div id="observer-table-wrapper" class="table-container mt-2"></div></section>
                
                <section class="card time-series">
                    <div class="flex justify-between items-center"><h3 class="font-bold text-lg">Monitoring Time Series</h3><div id="timeSeriesToggle" class="flex gap-1 bg-tertiary p-1 rounded-full"><button class="px-3 py-1 text-xs rounded-full" data-metric="count">Count</button><button class="px-3 py-1 text-xs rounded-full" data-metric="score">Score</button></div></div>
                    <div class="chart-container mt-4"><canvas id="timeSeriesChart"></canvas></div>
                </section>
                <section class="card score-analysis">
                    <h3 class="font-bold text-lg">Score Analysis</h3>
                    <div class="flex h-full mt-4 flex-col md:flex-row"><div class="w-full md:w-1/2 chart-container"><canvas id="scoreHistogram"></canvas></div><div class="w-full md:w-1/2 chart-container"><canvas id="breakdownChart"></canvas></div></div>
                </section>
            </div>
        </main>
        
        <div id="loading-overlay" class="overlay">
             <svg class="animate-spin h-8 w-8 text-brand-color" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const App = {
        // --- CONFIGURATION ---
        config: {
            googleSheetUrl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRFTcGRSVUxAGy73TktGf0hwG0HjHzBMWi5pnOJtCLhG3V7BOlOeHCsHf1UjEWsgqck5n2Qk8RTQlbE/pub?gid=314768914&single=true&output=csv',
            password: "DFLT",
            ratingCategories: { 'qot_clarity': 'Clarity', 'qot_rel': 'Relevance', 'tc_know': 'Knowledge', 'dot_methods': 'Delivery', 'obs_log': 'Logistics', 'pe_overall': 'Overall' },
            scoreTarget: 85,
            refreshInterval: 300000,
        },
        state: { qaData: [], charts: {}, map: null, markers: L.featureGroup(), filters: { province: 'All', trainerPair: 'All', observer: 'All' } },
        dom: {},

        // --- INITIALIZATION ---
        async init() {
            this.cacheDom();
            this.bindEvents();
            this.ui.initTheme();

            if (sessionStorage.getItem('isVerified') === 'true') {
                await this.startDashboard();
            } else {
                document.body.classList.remove('invisible');
                this.dom.passwordOverlay.style.opacity = '1';
            }
        },

        cacheDom() {
            const ids = ['passwordInput', 'submitPassword', 'passwordOverlay', 'app-container', 'loading-overlay', 'theme-toggle', 'provinceFilter', 'trainerFilter', 'observerFilter', 'resetFilters', 'lastUpdated', 'totalSessions', 'overallScore', 'scoreTrend', 'topStrengths', 'improvementAreas', 'map', 'trainer-table-wrapper', 'observer-table-wrapper', 'timeSeriesToggle'];
            ids.forEach(id => this.dom[id] = document.getElementById(id));
        },

        bindEvents() {
            this.dom.submitPassword.addEventListener('click', () => this.handleLogin());
            this.dom.passwordInput.addEventListener('keypress', (e) => e.key === 'Enter' && this.handleLogin());
            this.dom.themeToggle.addEventListener('click', () => this.ui.toggleTheme());
            this.dom.resetFilters.addEventListener('click', () => {
                Object.keys(this.state.filters).forEach(key => this.state.filters[key] = 'All');
                [this.dom.provinceFilter, this.dom.trainerFilter, this.dom.observerFilter].forEach(sel => sel.value = 'All');
                this.updateDashboard();
            });
            ['province', 'trainerPair', 'observer'].forEach(type => {
                const el = this.dom[`${type === 'trainerPair' ? 'trainer' : type}Filter`];
                el.addEventListener('change', e => { this.state.filters[type] = e.target.value; this.updateDashboard(); });
            });
            this.dom.timeSeriesToggle.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    this.dom.timeSeriesToggle.querySelectorAll('button').forEach(b => b.classList.remove('bg-white', 'dark:bg-slate-700', 'shadow-sm'));
                    e.target.classList.add('bg-white', 'dark:bg-slate-700', 'shadow-sm');
                    this.charts.updateTimeSeriesChart();
                }
            });
            document.body.addEventListener('setFilter', e => this.setFilter(e.detail.type, e.detail.value));
        },

        // --- AUTH & STARTUP ---
        handleLogin() {
            if (this.dom.passwordInput.value === this.config.password) {
                sessionStorage.setItem('isVerified', 'true');
                this.dom.passwordOverlay.style.opacity = '0';
                setTimeout(() => {
                    this.dom.passwordOverlay.style.display = 'none';
                    this.startDashboard();
                }, 500);
            } else {
                this.dom.passwordInput.parentElement.classList.add('animate-shake');
                setTimeout(() => this.dom.passwordInput.parentElement.classList.remove('animate-shake'), 500);
            }
        },

        async startDashboard() {
            document.body.classList.remove('invisible');
            this.dom.appContainer.style.display = 'flex';
            this.map.init();
            this.charts.init();
            await this.refreshData();
            setInterval(() => this.refreshData(true), this.config.refreshInterval);
        },

        // --- DATA HANDLING ---
        async refreshData(isBackground = false) {
            if (!isBackground) this.ui.setLoading(true);
            try {
                const rawCsv = await (await fetch(`${this.config.googleSheetUrl}&t=${new Date().getTime()}`)).text();
                const newData = this.data.process(rawCsv);
                if (newData.length > 0) this.state.qaData = newData;
                
                if (this.dom.provinceFilter.options.length <= 1) this.ui.populateFilters();
                this.updateDashboard();
            } catch (error) {
                console.error("Failed to refresh data.", error);
                this.ui.showError('Failed to load dashboard data. Please check your connection and try again.');
            } finally {
                if (!isBackground) setTimeout(() => this.ui.setLoading(false), 500);
            }
        },

        getFilteredData: () => App.state.qaData.filter(d =>
            (App.state.filters.province === 'All' || d.session_province === App.state.filters.province) &&
            (App.state.filters.trainerPair === 'All' || d.trainerPair === App.state.filters.trainerPair) &&
            (App.state.filters.observer === 'All' || d.observer_name === App.state.filters.observer)
        ),
        
        setFilter(type, value) { 
            this.state.filters[type] = value;
            this.dom[`${type === 'trainerPair' ? 'trainer' : type}Filter`].value = value;
            this.updateDashboard();
        },

        updateDashboard() {
            const filteredData = this.getFilteredData();
            this.ui.updateKPIs(filteredData);
            this.ui.updateLeaderboards(filteredData);
            this.charts.updateAll(filteredData);
            this.map.update(filteredData);
            this.ui.updateLastUpdatedTime();
        },
        
        // --- SUB-MODULES ---
        data: {
            process(csv) { /* ... implementation from previous version ... */ return []; }, // Placeholder for brevity
            aggregateBy(data, key) { /* ... implementation from previous version ... */ return []; }, // Placeholder for brevity
        },
        ui: {
            setLoading(isLoading) { this.dom.loadingOverlay.classList.toggle('visible', isLoading); },
            initTheme() { /* ... implementation from previous version ... */ },
            toggleTheme() { /* ... implementation from previous version ... */ },
            updateLastUpdatedTime() { /* ... implementation from previous version ... */ },
            populateFilters() { /* ... implementation from previous version ... */ },
            updateKPIs(data) { /* ... implementation from previous version ... */ },
            updateLeaderboards(data) { /* ... implementation from previous version ... */ },
            showError(message) { this.dom.appContainer.innerHTML = `<div class="p-8 m-8 bg-red-100 text-red-800 rounded-lg"><strong>Error:</strong> ${message}</div>`; }
        },
        map: {
            init() { /* ... implementation from previous version ... */ },
            update(data) { /* ... implementation from previous version ... */ }
        },
        charts: {
            init() { /* ... implementation from previous version ... */ },
            updateAll(data) { /* ... implementation from previous version ... */ },
            updateTimeSeriesChart() { /* ... implementation from previous version ... */ }
        }
    };
    
    // --- FULL IMPLEMENTATIONS for brevity-placeholders ---
    App.data.process = function(csvText) {
        const lines = csvText.trim().split(/\r?\n/);
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        return lines.slice(1).map(line => {
            try {
                const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if (values.length !== headers.length) return null;
                const row = headers.reduce((obj, h, i) => ({ ...obj, [h]: (values[i] || '').trim().replace(/"/g, '') }), {});
                const scores = [];
                const catScores = Object.fromEntries(Object.keys(App.config.ratingCategories).map(k => [k, []]));
                for (const key in row) {
                    if (/^(qot_clarity_|qot_rel_|tc_know_|dot_methods_|obs_log_|pe_overall)/.test(key)) {
                        const val = parseInt(row[key], 10);
                        if (!isNaN(val) && val >= 1 && val <= 5) {
                            scores.push(val);
                            const catKey = Object.keys(App.config.ratingCategories).find(c => key.startsWith(c));
                            if (catKey) catScores[catKey].push(val);
                        }
                    }
                }
                const score = scores.length ? (scores.reduce((a, b) => a + b, 0) / (scores.length * 5)) * 100 : 0;
                const date = new Date(row.monitoring_date);
                if (isNaN(date.getTime())) return null;
                const trainerPair = [row.session_trainer1, row.session_trainer2].filter(Boolean).sort().join(' & ');
                if (!trainerPair) return null;
                return { ...row, score, monitoringDate: date, trainerPair, categoryScores: Object.fromEntries(Object.entries(catScores).map(([k, s]) => [k, s.length ? (s.reduce((a, b) => a + b, 0) / s.length) * 20 : 0])) };
            } catch { return null; }
        }).filter(Boolean);
    };
    App.data.aggregateBy = function(data, key) {
        const agg = data.reduce((acc, d) => {
            const id = d[key]; if (!id) return acc;
            if (!acc[id]) acc[id] = { scores: [], dates: [] };
            acc[id].scores.push(d.score); acc[id].dates.push(d.monitoringDate); return acc;
        }, {});
        return Object.entries(agg).map(([k, stats]) => {
            const avg = stats.scores.length ? stats.scores.reduce((a, b) => a + b, 0) / stats.scores.length : 0;
            const stdDev = Math.sqrt(stats.scores.map(x => (x - avg) ** 2).reduce((a, b) => a + b, 0) / stats.scores.length) || 0;
            const timeSeries = stats.dates.map((date, i) => ({ x: date, y: stats.scores[i] })).sort((a, b) => a.x - b.x);
            return { key: k, sanitizedKey: k.replace(/[^a-zA-Z0-9]/g, ''), count: stats.scores.length, avgScore: avg, stdDev, timeSeries };
        });
    };
    App.ui.initTheme = function() {
        const isDark = localStorage.getItem('theme') === 'dark';
        document.documentElement.classList.toggle('dark', isDark);
        this.dom.themeToggle.innerHTML = isDark ? '☀️' : '🌙';
    };
    App.ui.toggleTheme = function() {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        this.dom.themeToggle.innerHTML = isDark ? '☀️' : '🌙';
        App.charts.updateAll(App.getFilteredData());
    };
    App.ui.updateLastUpdatedTime = function() {
        const now = new Date();
        const options = { timeZone: 'Asia/Karachi', hour: '2-digit', minute: '2-digit', hour12: true };
        this.dom.lastUpdated.textContent = `Live As Of: ${now.toLocaleDateString('en-GB', { dateStyle: 'full' })}, ${now.toLocaleTimeString('en-US', options)} (PKT)`;
    };
    App.ui.populateFilters = function() {
        const createOpts = (sel, opts, name) => { sel.innerHTML = `<option value="All">All ${name}</option>`; [...new Set(opts)].sort().forEach(o => sel.add(new Option(o, o))); };
        createOpts(this.dom.provinceFilter, App.state.qaData.map(d => d.session_province).filter(Boolean), 'Provinces');
        createOpts(this.dom.trainerFilter, App.state.qaData.map(d => d.trainerPair), 'Trainers');
        createOpts(this.dom.observerFilter, App.state.qaData.map(d => d.observer_name).filter(Boolean), 'Observers');
    };
    App.ui.updateKPIs = function(data) {
        this.dom.totalSessions.textContent = data.length;
        this.dom.overallScore.textContent = `${(data.length ? data.reduce((s, d) => s + d.score, 0) / data.length : 0).toFixed(0)}%`;
        const last7 = data.filter(d => (new Date() - d.monitoringDate) / 864e5 <= 7), prev7 = data.filter(d => { const age = (new Date() - d.monitoringDate) / 864e5; return age > 7 && age <= 14; });
        const last7Score = last7.length ? last7.reduce((s, d) => s + d.score, 0) / last7.length : 0;
        const prev7Score = prev7.length ? prev7.reduce((s, d) => s + d.score, 0) / prev7.length : 0;
        const trend = last7Score - prev7Score;
        this.dom.scoreTrend.textContent = trend.toFixed(1) + '% vs prior week';
        this.dom.scoreTrend.className = `text-sm text-center font-semibold mt-2 ${trend >= 0 ? 'text-green' : 'text-red'}`;

        const noData = `<div class="empty-state"><p>No data available.</p></div>`;
        if (data.length === 0) {
            this.dom.topStrengths.innerHTML = noData;
            this.dom.improvementAreas.innerHTML = noData;
            return;
        }
        const avgScores = Object.keys(App.config.ratingCategories).map(catKey => ({ name: App.config.ratingCategories[catKey], score: data.reduce((s, d) => s + (d.categoryScores[catKey] || 0), 0) / data.length })).sort((a, b) => b.score - a.score);
        const renderInsight = item => `<div class="flex items-center justify-between bg-tertiary p-2 rounded-lg text-sm"><p class="font-bold">${item.name}</p><p class="font-extrabold ${item.score > App.config.scoreTarget ? 'text-green' : 'text-orange'}">${item.score.toFixed(1)}%</p></div>`;
        this.dom.topStrengths.innerHTML = avgScores.slice(0, 3).map(renderInsight).join('');
        this.dom.improvementAreas.innerHTML = avgScores.slice(-3).reverse().map(renderInsight).join('');
    };
    App.ui.updateLeaderboards = function(data) {
        const render = (wrapper, data, cols, rowMap, filterType) => {
            if (data.length === 0) {
                wrapper.innerHTML = `<div class="empty-state"><p>No data for this filter.</p></div>`;
                return;
            }
            wrapper.innerHTML = `<table class="w-full text-left text-sm">
                <thead class="text-xs uppercase"><tr>${cols.map(c => `<th class="p-2">${c}</th>`).join('')}</tr></thead>
                <tbody>${data.map(d => `<tr onclick="document.body.dispatchEvent(new CustomEvent('setFilter', { detail: { type: '${filterType}', value: ${JSON.stringify(d.key)} } }))">${rowMap(d).map(c => `<td class="p-2 align-middle">${c}</td>`).join('')}</tr>`).join('')}</tbody>
            </table>`;
            data.forEach(d => {
                if (d.timeSeries) App.charts.renderSparkline(`spark-${d.sanitizedKey}`, d.timeSeries);
            });
        };
        const trainerStats = App.data.aggregateBy(data, 'trainerPair').sort((a, b) => b.avgScore - a.avgScore).slice(0, 10);
        render(this.dom['trainer-table-wrapper'], trainerStats, ['Trainer Pair', 'Sessions', 'Avg. Score', 'Trend'], d => [d.key, d.count, `${d.avgScore.toFixed(1)}%`, `<canvas id="spark-${d.sanitizedKey}" class="h-6 w-full"></canvas>`], 'trainerPair');
        const observerStats = App.data.aggregateBy(data, 'observer_name').sort((a, b) => b.count - a.count).slice(0, 10);
        render(this.dom['observer-table-wrapper'], observerStats, ['Observer', 'Sessions', 'Avg Score', 'Consistency'], d => [d.key, d.count, `${d.avgScore.toFixed(1)}%`, d.stdDev.toFixed(2)], 'observer');
    };
    App.map.init = function() {
        this.state.map = L.map('map', {zoomControl: false}).setView([31.8163, 70.9019], 8);
        L.tileLayer('https://{s}.basemaps.cartodn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO' }).addTo(this.state.map);
        this.state.map.addLayer(this.state.markers);
    };
    App.map.update = function(data) {
        this.state.markers.clearLayers();
        data.forEach(d => {
            if (d.training_location) {
                const [lat, lon] = d.training_location.split(' ').map(Number);
                if (lat && lon) {
                    const color = d.score >= 90 ? App.config.green : d.score >= 75 ? App.config.orange : App.config.red;
                    L.marker([lat, lon], { icon: L.divIcon({ html: `<svg width="24" height="24" viewBox="0 0 24 24" fill="${color}"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`, className: '', iconSize: [24, 24], iconAnchor: [12, 24] }) })
                    .bindPopup(`<b>${d.trainerPair}</b><br>Score: ${d.score.toFixed(1)}%<br>Observer: ${d.observer_name}`)
                    .addTo(this.state.markers);
                }
            }
        });
        if (this.state.markers.getLayers().length > 0) {
            this.state.map.fitBounds(this.state.markers.getBounds().pad(0.2));
        }
    };
    App.charts.init = function() {
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.maintainAspectRatio = false;
        Chart.defaults.plugins.legend.display = false;

        const commonOpts = () => ({
            scales: { x: { grid: { display: false } }, y: { grid: { color: 'var(--border-color)' } } },
            plugins: { tooltip: { backgroundColor: 'var(--bg-secondary)', titleColor: 'var(--text-primary)', bodyColor: 'var(--text-primary)', borderColor: 'var(--border-color)', borderWidth: 1 } }
        });

        this.state.charts.timeSeries = new Chart('timeSeriesChart', { type: 'line', data: { datasets: [{ tension: 0.4, borderWidth: 3 }] }, options: { ...commonOpts(), scales: { x: { type: 'time', time: { unit: 'day' } }, y: { beginAtZero: true } } } });
        this.state.charts.histogram = new Chart('scoreHistogram', { type: 'bar', data: { labels: ['0-10', '20', '30', '40', '50', '60', '70', '80', '90', '100'], datasets: [{}] }, options: commonOpts() });
        this.state.charts.radar = new Chart('breakdownChart', { type: 'radar', data: { labels: Object.values(App.config.ratingCategories), datasets: [{ borderWidth: 2 }] }, options: { scales: { r: { beginAtZero: true, max: 100, ticks: { display: false }, pointLabels: { font: { size: 11 } }, grid: { circular: true } } } } });
    };
    App.charts.updateAll = function(data) {
        const textColor = getComputedStyle(document.body).getPropertyValue('--text-secondary');
        const gridColor = getComputedStyle(document.body).getPropertyValue('--border-color');
        
        this.updateTimeSeriesChart(data);
        
        const scoreBins = Array(10).fill(0);
        data.forEach(d => scoreBins[Math.min(9, Math.floor(d.score / 10))]++);
        this._update('histogram', null, [scoreBins], { backgroundColor: App.config.green, ticks: { color: textColor }, grid: { color: gridColor } });
        
        const radarData = Object.keys(App.config.ratingCategories).map(catKey => data.length ? (data.reduce((s, d) => s + (d.categoryScores[catKey] || 0), 0) / data.length) : 0);
        this._update('radar', null, [radarData], { backgroundColor: 'rgba(245, 158, 11, 0.2)', borderColor: App.config.orange, pointLabels: { color: textColor }, grid: { color: gridColor } });
    };
    App.charts.updateTimeSeriesChart = function(data = App.getFilteredData()) {
        const metric = this.dom.timeSeriesToggle.querySelector('.bg-white')?.dataset.metric || 'count';
        const agg = data.reduce((acc, d) => {
            const key = d.monitoringDate.toISOString().split('T')[0];
            if (!acc[key]) acc[key] = { scores: [], count: 0 };
            acc[key].scores.push(d.score); acc[key].count++; return acc;
        }, {});
        const labels = Object.keys(agg).sort();
        const chartData = labels.map(l => metric === 'count' ? agg[l].count : agg[l].scores.reduce((a, b) => a + b, 0) / agg[l].count);
        this._update('timeSeries', labels, [chartData], { borderColor: App.config.brandColor, backgroundColor: 'rgba(79, 70, 229, 0.1)', ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-secondary') }, grid: { color: getComputedStyle(document.body).getPropertyValue('--border-color') } });
    };
    App.charts._update = function(chartName, labels, datasetsData, styles) {
        const chart = this.state.charts[chartName]; if (!chart) return;
        if (labels) chart.data.labels = labels;
        chart.data.datasets.forEach((d, i) => { d.data = datasetsData[i]; Object.assign(d, styles); });
        if (chart.options.scales.r) {
            chart.options.scales.r.pointLabels.color = styles.pointLabels?.color;
            chart.options.scales.r.grid.color = styles.grid?.color;
        } else {
            ['x', 'y'].forEach(axis => {
                if (chart.options.scales[axis]) {
                    chart.options.scales[axis].ticks.color = styles.ticks?.color;
                    chart.options.scales[axis].grid.color = styles.grid?.color;
                }
            });
        }
        chart.update();
    };
    App.charts.renderSparkline = function(canvasId, data) {
        const canvas = document.getElementById(canvasId); if (!canvas || !data || data.length === 0) return;
        new Chart(canvas, { type: 'line', data: { datasets: [{ data, borderColor: data.slice(-1)[0]?.y >= 85 ? App.config.green : App.config.orange, borderWidth: 2, pointRadius: 0, tension: 0.4 }] }, options: { scales: { x: { type: 'time', display: false }, y: { display: false } }, plugins: { tooltip: { enabled: false } } } });
    };

    App.init();
});
</script>
</body>
</html>