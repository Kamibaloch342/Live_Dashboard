<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DFLT | Ultimate QA Analytics</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        /* === Using the exact 'Status Deck' styling you provided === */
        :root {
            --bg-color: #f0f4f8; --card-bg: #ffffff; --border-color: #e2e8f0;
            --text-primary: #1e293b; --text-secondary: #64748b; --brand-color: #4f46e5;
        }
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-color);
            background-image: linear-gradient(175deg, var(--bg-color) 0%, #dbe7f2 100%);
            color: var(--text-primary);
        }
        h1, h2, h3, h4, p, span, div, label, select, button, table, th, td {
            font-family: 'Montserrat', sans-serif !important;
            color: var(--text-primary);
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-auto-rows: minmax(100px, auto);
            gap: 1.5rem; padding: 1.5rem;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px); border-radius: 1.5rem;
            border: 1px solid var(--border-color); padding: 1.5rem;
            display: flex; flex-direction: column;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            min-height: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card:hover {
            box-shadow: 0 12px 30px rgba(0,0,0,0.12);
            transform: translateY(-5px);
        }
        .chart-container { flex-grow: 1; position: relative; }
        canvas { position: absolute; top: 0; left: 0; width: 100% !important; height: 100% !important; }
        .table-container { flex-grow: 1; overflow-y: auto; min-height: 0; }
        .table-container thead { background-color: #f3f4f6; position: sticky; top: 0; z-index: 1; }
        .table-container tbody tr { transition: background-color 0.2s; cursor: pointer; }
        .table-container tbody tr:hover { background-color: var(--bg-color); }
        .filter-select { padding: 0.5rem; border-radius: 0.5rem; border: 1px solid var(--border-color); background-color: #f8fafc; }
        
        /* Grid placements */
        .header { grid-column: 1 / -1; }
        .kpi-card { text-align: center; justify-content: center; }
        .kpi-1 { grid-column: 1 / 3; } .kpi-2 { grid-column: 3 / 5; } .kpi-3 { grid-column: 5 / 7; }
        .kpi-4 { grid-column: 7 / 10; } .kpi-5 { grid-column: 10 / -1; }
        .trainer-leaderboard { grid-column: 1 / 7; grid-row: 3 / 6; }
        .observer-leaderboard { grid-column: 7 / -1; grid-row: 3 / 6; }
        .daily-activity { grid-column: 1 / 7; grid-row: 6 / 9; }
        .score-distribution { grid-column: 7 / -1; grid-row: 6 / 9; }
        .map-card { grid-column: 1 / -1; grid-row: 9 / 12; }

    </style>
</head>
<body>
    <div class="dashboard-grid" id="dashboard-content">
        <header class="card header flex flex-wrap items-center justify-between gap-4">
            <div>
                <h1 class="text-2xl font-extrabold text-gray-900">DFLT Quality Assurance Analytics</h1>
                <p class="text-sm text-gray-500">High-Fidelity Performance & Monitoring Deck</p>
            </div>
            <div class="flex items-center gap-3 flex-wrap">
                <select id="provinceFilter" class="filter-select"></select>
                <select id="trainerFilter" class="filter-select"></select>
                <select id="observerFilter" class="filter-select"></select>
                <button id="resetFilters" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-md" title="Reset Filters">ðŸ”„</button>
            </div>
        </header>

        <div class="card kpi-card kpi-1"><h3 class="font-semibold text-gray-600">Total Monitored</h3><p id="totalSessions" class="text-5xl font-black text-indigo-600 mt-1">0</p></div>
        <div class="card kpi-card kpi-2">
            <h3 class="font-semibold text-gray-600">Session Days</h3>
            <div class="flex justify-around items-center mt-2">
                <div><p class="font-bold text-gray-500 text-sm">Day 1</p><p id="day1Sessions" class="text-3xl font-bold text-blue-600">0</p></div>
                <div><p class="font-bold text-gray-500 text-sm">Day 2</p><p id="day2Sessions" class="text-3xl font-bold text-green-600">0</p></div>
            </div>
        </div>
        <div class="card kpi-card kpi-3">
             <h3 class="font-semibold text-gray-600">Overall Avg Score</h3>
             <p id="overallScore" class="text-5xl font-black text-teal-600 mt-1">0<span class="text-3xl">%</span></p>
        </div>
        <div class="card kpi-4 flex-row items-center gap-4">
            <div class="flex-grow"><h3 class="font-semibold text-gray-600">Analytical Insights</h3><p id="summaryText" class="text-sm text-gray-800 mt-1">Loading insights...</p></div>
            <div id="scoreTrend" class="w-24 h-16"></div>
        </div>
        <div class="card kpi-5 flex-row items-center gap-4">
            <div class="flex-grow"><h3 class="font-semibold text-gray-600">Top Categories</h3><p id="topCategory" class="text-xl font-bold text-orange-500 mt-1">N/A</p></div>
            <div class="flex-grow"><h3 class="font-semibold text-gray-600">Weakest Category</h3><p id="bottomCategory" class="text-xl font-bold text-red-500 mt-1">N/A</p></div>
        </div>

        <div class="card trainer-leaderboard">
            <h3 class="text-md font-bold text-gray-800 flex-shrink-0">Trainer Performance Leaderboard</h3>
            <div class="table-container mt-2">
                <table class="w-full text-left text-sm">
                    <thead class="text-xs text-gray-600 uppercase"><tr><th class="p-2">Trainer</th><th class="p-2">Sessions</th><th class="p-2">Avg. Score</th></tr></thead>
                    <tbody id="trainerTableBody"></tbody>
                </table>
            </div>
        </div>
        <div class="card observer-leaderboard">
            <h3 class="text-md font-bold text-gray-800 flex-shrink-0">QA Observer Activity</h3>
            <div class="table-container mt-2">
                <table class="w-full text-left text-sm">
                    <thead class="text-xs text-gray-600 uppercase"><tr><th class="p-2">Observer</th><th class="p-2">Sessions</th><th class="p-2">Avg Score Given</th></tr></thead>
                    <tbody id="observerTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="card daily-activity">
            <h3 class="text-md font-bold text-gray-800 flex-shrink-0">Daily Monitoring Trend</h3>
            <div class="chart-container"><canvas id="dailyActivityChart"></canvas></div>
        </div>
        <div class="card score-distribution">
            <h3 class="text-md font-bold text-gray-800 flex-shrink-0">Score Distribution & Category Breakdown</h3>
            <div class="flex h-full">
                <div class="w-1/2 chart-container"><canvas id="scoreHistogram"></canvas></div>
                <div class="w-1/2 chart-container"><canvas id="breakdownChart"></canvas></div>
            </div>
        </div>

        <div class="card map-card !p-1">
            <div id="map" class="h-full w-full"></div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    // --- CONFIGURATION ---
    const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRFTcGRSVUxAGy73TktGf0hwG0HjHzBMWi5pnOJtCLhG3V7BOlOeHCsHf1UjEWsgqck5n2Qk8RTQlbE/pub?gid=314768914&single=true&output=csv';

    // --- GLOBAL STATE ---
    let qaData = [];
    let charts = {};
    let map, markers = L.featureGroup();
    let filters = { province: 'All', trainerPair: 'All', observer: 'All' };
    const RATING_CATEGORIES = {
        'qot_clarity': 'Clarity', 'qot_rel': 'Relevance', 'tc_know': 'Knowledge',
        'dot_methods': 'Delivery', 'obs_log': 'Logistics', 'pe_overall': 'Overall'
    };
    const RATING_COLUMNS_REGEX = /^(qot_clarity_|qot_rel_|tc_know_|dot_methods_|obs_log_|pe_overall)/;

    // --- DATA PROCESSING ---
    function processCSVData(csvText) {
        const lines = csvText.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        return lines.slice(1).map(line => {
            const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            const row = headers.reduce((obj, h, i) => ({ ...obj, [h]: (values[i] || '').trim().replace(/"/g, '') }), {});
            
            let scores = [];
            let categoryScores = Object.fromEntries(Object.keys(RATING_CATEGORIES).map(key => [key, []]));
            Object.keys(row).forEach(key => {
                if (RATING_COLUMNS_REGEX.test(key)) {
                    const value = parseInt(row[key], 10);
                    if (!isNaN(value)) {
                        scores.push(value);
                        const catKey = Object.keys(RATING_CATEGORIES).find(c => key.startsWith(c));
                        if(catKey) categoryScores[catKey].push(value);
                    }
                }
            });
            const score = scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / (scores.length * 5)) * 100 : 0;

            return {
                ...row,
                score,
                categoryScores: Object.fromEntries(Object.entries(categoryScores).map(([k, s]) => [k, s.length ? s.reduce((a,b)=>a+b,0)/s.length : 0])),
                trainerPair: [row.session_trainer1, row.session_trainer2].filter(Boolean).sort().join(' & '),
                monitoringDate: row.monitoring_date ? new Date(row.monitoring_date) : null,
            };
        }).filter(d => d.trainerPair && d.monitoringDate && !isNaN(d.monitoringDate.getTime()));
    }

    // --- DASHBOARD UPDATE LOGIC ---
    function updateDashboard() {
        const filtered = qaData.filter(d =>
            (filters.province === 'All' || d.session_province === filters.province) &&
            (filters.trainerPair === 'All' || d.trainerPair === filters.trainerPair) &&
            (filters.observer === 'All' || d.observer_name === filters.observer)
        );
        updateKPIs(filtered);
        updateLeaderboards(filtered);
        updateCharts(filtered);
        updateMap(filtered);
    }
    
    // --- Component Update Functions ---
    function updateKPIs(data) {
        document.getElementById('totalSessions').textContent = data.length;
        document.getElementById('day1Sessions').textContent = data.filter(d => d.day_of_monitoring === 'day1').length;
        document.getElementById('day2Sessions').textContent = data.filter(d => d.day_of_monitoring === 'day2').length;
        const avgScore = data.length ? data.reduce((s, d) => s + d.score, 0) / data.length : 0;
        document.getElementById('overallScore').innerHTML = `${avgScore.toFixed(0)}<span class="text-3xl">%</span>`;
        
        // Advanced Insights
        const categoryAvgs = Object.keys(RATING_CATEGORIES).map(catKey => ({
            name: RATING_CATEGORIES[catKey],
            score: data.length ? data.reduce((s,d) => s + (d.categoryScores[catKey] || 0), 0) / data.length : 0
        })).sort((a,b) => b.score - a.score);

        document.getElementById('topCategory').textContent = categoryAvgs[0]?.name || 'N/A';
        document.getElementById('bottomCategory').textContent = categoryAvgs[categoryAvgs.length-1]?.name || 'N/A';
        
        // Summary Text
        const last7DaysData = data.filter(d => (new Date() - d.monitoringDate) / (1000*60*60*24) <= 7);
        const last7DaysScore = last7DaysData.length ? last7DaysData.reduce((s, d) => s + d.score, 0) / last7DaysData.length : avgScore;
        const trend = last7DaysScore - avgScore;
        document.getElementById('summaryText').textContent = `The average score in the last 7 days is ${last7DaysScore.toFixed(1)}%, a change of ${trend.toFixed(1)} points. ${last7DaysData.length} sessions were monitored.`;
    }

    function updateLeaderboards(data) {
        const createRow = (d, type) => {
            const row = document.createElement('tr');
            row.onclick = () => setFilter(type, d.key);
            row.innerHTML = `<td class="p-2 font-bold">${d.key}</td><td class="p-2">${d.count}</td><td class="p-2"><div class="w-full bg-gray-200 rounded-full h-2"><div class="h-2 rounded-full" style="width:${d.avgScore}%; background-color:${getScoreColor(d.avgScore)};"></div></div><span class="text-xs">${d.avgScore.toFixed(1)}%</span></td>`;
            return row;
        };
        
        const trainerStats = aggregateBy(data, 'trainerPair').sort((a,b) => b.avgScore - a.avgScore);
        const observerStats = aggregateBy(data, 'observer_name').sort((a,b) => b.count - a.count);
        
        const trainerBody = document.getElementById('trainerTableBody');
        trainerBody.innerHTML = '';
        trainerStats.forEach(d => trainerBody.appendChild(createRow(d, 'trainerPair')));

        const observerBody = document.getElementById('observerTableBody');
        observerBody.innerHTML = '';
        observerStats.forEach(d => observerBody.appendChild(createRow(d, 'observer')));
    }

    function updateCharts(data) {
        // Daily Activity
        const activity = aggregateByDate(data, 'monitoringDate');
        charts.daily.data.labels = activity.labels;
        charts.daily.data.datasets[0].data = activity.data;
        charts.daily.update();

        // Score Histogram
        const scoreBins = Array(10).fill(0);
        data.forEach(d => {
            const bin = Math.min(9, Math.floor(d.score / 10));
            scoreBins[bin]++;
        });
        charts.histogram.data.datasets[0].data = scoreBins;
        charts.histogram.update();

        // Breakdown Radar
        charts.radar.data.datasets[0].data = Object.keys(RATING_CATEGORIES).map(catKey => 
            data.length ? (data.reduce((s,d) => s + (d.categoryScores[catKey] || 0), 0) / data.length) * 20 : 0
        );
        charts.radar.update();
    }

    function updateMap(data) {
        markers.clearLayers();
        data.forEach(d => {
            if (d.training_location) {
                const [lat, lon] = d.training_location.split(' ').map(Number);
                if(lat && lon) {
                    const marker = L.circleMarker([lat, lon], { radius: 7, fillColor: getScoreColor(d.score), color: "#fff", weight: 1.5, fillOpacity: 0.9 });
                    marker.bindPopup(`<b>${d.trainerPair}</b><br>Score: ${d.score.toFixed(1)}%<br>Observer: ${d.observer_name}`);
                    markers.addLayer(marker);
                }
            }
        });
        if(markers.getLayers().length > 0) map.fitBounds(markers.getBounds().pad(0.1));
    }
    
    // --- INITIALIZATION FUNCTIONS ---
    function initializeAllCharts() {
        Chart.defaults.font.family = "'Montserrat', sans-serif";
        Chart.defaults.color = '#64748b';
        charts.daily = new Chart('dailyActivityChart', { type: 'line', data: { datasets: [{ tension: 0.4, borderColor: '#4f46e5' }] }, options: { scales: { x: { type: 'time', time: { unit: 'day' } } } } });
        charts.histogram = new Chart('scoreHistogram', { type: 'bar', data: { labels: ['0-10', '10-20', '20-30', '30-40', '40-50', '50-60', '60-70', '70-80', '80-90', '90-100'], datasets: [{ backgroundColor: '#10b981' }] }, options: { plugins: { legend: { display: false } } } });
        charts.radar = new Chart('breakdownChart', { type: 'radar', data: { labels: Object.values(RATING_CATEGORIES), datasets: [{ backgroundColor: 'rgba(249, 115, 22, 0.2)', borderColor: 'rgb(249, 115, 22)' }] }, options: { scales: { r: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } } });
    }
    
    function populateFilters(data) {
        const createOptions = (sel, options, name) => { sel.innerHTML = `<option value="All">All ${name}</option>`; options.forEach(o => sel.add(new Option(o, o))); };
        createOptions(document.getElementById('provinceFilter'), [...new Set(data.map(d => d.session_province))].sort(), 'Provinces');
        createOptions(document.getElementById('trainerFilter'), [...new Set(data.map(d => d.trainerPair))].sort(), 'Trainers');
        createOptions(document.getElementById('observerFilter'), [...new Set(data.map(d => d.observer_name))].filter(Boolean).sort(), 'Observers');
    }

    // --- HELPERS ---
    const getScoreColor = s => s >= 90 ? '#16a34a' : s >= 75 ? '#f59e0b' : '#dc2626';
    const setFilter = (type, value) => { filters[type] = value; document.getElementById({province:'provinceFilter',trainerPair:'trainerFilter',observer:'observerFilter'}[type]).value = value; updateDashboard(); };
    const aggregateBy = (data, key) => Object.entries(data.reduce((acc, d) => {
        const id = d[key]; if (!id) return acc;
        if (!acc[id]) acc[id] = { scores: [] }; acc[id].scores.push(d.score); return acc;
    }, {})).map(([k, stats]) => ({ key: k, count: stats.scores.length, avgScore: stats.scores.reduce((a,b)=>a+b,0) / stats.scores.length }));
    const aggregateByDate = (data, dateKey) => {
        const aggregated = data.reduce((acc, d) => {
            const key = d[dateKey].toISOString().split('T')[0]; acc[key] = (acc[key] || 0) + 1; return acc;
        }, {});
        const labels = Object.keys(aggregated).sort();
        return { labels, data: labels.map(l => aggregated[l]) };
    };

    // --- MAIN EXECUTION ---
    try {
        const response = await fetch(`${GOOGLE_SHEET_CSV_URL}&t=${new Date().getTime()}`);
        qaData = processCSVData(await response.text());
        
        map = L.map('map').setView([30.3753, 69.3451], 5.5);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
        map.addLayer(markers);

        initializeAllCharts();
        populateFilters(qaData);
        updateDashboard();

        // Event Listeners
        ['provinceFilter', 'trainerFilter', 'observerFilter'].forEach(id => document.getElementById(id).addEventListener('change', e => {
            filters[id.replace('Filter','')] = e.target.value;
            updateDashboard();
        }));
        document.getElementById('resetFilters').addEventListener('click', () => {
            filters = { province: 'All', trainerPair: 'All', observer: 'All' };
            document.querySelectorAll('select').forEach(s => s.value = 'All');
            updateDashboard();
        });
    } catch (error) {
        console.error("Dashboard failed to load:", error);
        document.body.innerHTML = `<div class="p-8 bg-red-100 text-red-800 rounded-lg"><strong>Error:</strong> Could not load dashboard data. ${error.message}</div>`;
    }
});
</script>
</body>
</html>