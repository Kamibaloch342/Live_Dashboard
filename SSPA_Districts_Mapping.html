<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DFLT Phase 2 - Deployment Dashboard</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --font-family: 'Montserrat', sans-serif;
            --bg-color: #F3F4F6;
            --text-color: #1F2937;
            --text-muted: #6B7280;
            --accent-color: #4F46E5;
            --success-color: #22C55E;
            --success-dark-color: #15803d;
            --warning-color: #F59E0B;
            --warning-light-color: #FFFBEB;
            --sidebar-bg: rgba(255, 255, 255, 0.55);
            --tooltip-bg: rgba(255, 255, 255, 0.85);
            --item-bg: rgba(255, 255, 255, 0.3);
            --item-hover-bg: rgba(255, 255, 255, 0.7);
            --border-color: rgba(229, 231, 235, 1);
            --shadow-color: rgba(0, 0, 0, 0.08);
            --blur-intensity: 15px;
        }

        body.dark-mode {
            --bg-color: #111827;
            --text-color: #F9FAFB;
            --text-muted: #9CA3AF;
            --accent-color: #6366F1;
            --success-color: #4ADE80;
            --success-dark-color: #22c55e;
            --warning-color: #FBBF24;
            --warning-light-color: #4A3A18;
            --sidebar-bg: rgba(29, 41, 59, 0.5);
            --tooltip-bg: rgba(29, 41, 59, 0.8);
            --item-bg: rgba(55, 65, 81, 0.4);
            --item-hover-bg: rgba(55, 65, 81, 0.8);
            --border-color: rgba(255, 255, 255, 0.08);
            --shadow-color: rgba(0, 0, 0, 0.25);
        }

        html, body {
            height: 100%; margin: 0; padding: 0; font-family: var(--font-family); color: var(--text-color);
            overflow: hidden; background-color: var(--bg-color); transition: background-color 0.5s ease;
        }

        body::before {
            content: ''; position: absolute; width: 200%; height: 200%; top: -50%; left: -50%;
            z-index: -1; background: linear-gradient(45deg, rgba(79, 70, 229, 0.15), rgba(99, 102, 241, 0.1), rgba(239, 68, 68, 0.15), rgba(59, 130, 246, 0.15));
            animation: gradient-pan 25s ease infinite;
        }
        body.dark-mode::before { background: linear-gradient(45deg, rgba(79, 70, 229, 0.2), rgba(99, 102, 241, 0.15), rgba(239, 68, 68, 0.1), rgba(14, 165, 233, 0.15)); }

        .dashboard-container { position: relative; height: 100vh; width: 100vw; animation: fade-in 0.8s ease; }
        #map-container { position: absolute; top: 0; left: 0; height: 100%; width: 100%; }
        #map { width: 100%; height: 100%; background: transparent; }
        .leaflet-tile-pane { transition: filter 0.5s ease; }
        .dark-mode .leaflet-tile-pane { filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7); }

        #sidebar {
            position: fixed; /* Changed from absolute */
            top: 20px; left: 20px; bottom: 20px; width: 380px; z-index: 1001;
            background: var(--sidebar-bg); backdrop-filter: blur(var(--blur-intensity)); -webkit-backdrop-filter: blur(var(--blur-intensity));
            border: 1px solid var(--border-color); border-radius: 24px; box-shadow: 0 8px 32px 0 var(--shadow-color);
            padding: 25px; display: flex; flex-direction: column; transition: all 0.3s ease;
        }
        .sidebar-header {
            display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px; margin-bottom: 20px;
        }
        .sidebar-header h1 { font-size: 28px; font-weight: 800; margin: 0 0 5px 0; color: var(--accent-color); letter-spacing: -1px; }
        .sidebar-header .subtitle { font-size: 14px; color: var(--text-muted); margin: 0; }
        #theme-toggle {
            background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); cursor: pointer;
            padding: 8px 10px; border-radius: 12px; font-size: 16px; transition: all 0.3s ease; flex-shrink: 0; margin-left: 15px;
        }
        #theme-toggle:hover { background: var(--item-hover-bg); color: var(--text-color); transform: scale(1.05) rotate(15deg); }
        #theme-toggle i { transition: transform 0.4s ease; }

        .sidebar-section-header { font-size: 16px; font-weight: 600; margin: 0 0 15px 0; color: var(--text-color); }
        .sidebar-section-header i { margin-right: 8px; color: var(--text-muted); }

        #overview-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; padding: 15px; background: var(--item-bg); border-radius: 14px; }
        .overview-stat { text-align: center; }
        .overview-stat-value { font-size: 24px; font-weight: 800; color: var(--accent-color); }
        .overview-stat-label { font-size: 11px; text-transform: uppercase; color: var(--text-muted); }

        .sidebar-filters { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .filter-group label { font-weight: 600; font-size: 12px; color: var(--text-muted); margin-bottom: 8px; display: block; text-transform: uppercase; }
        .filter-group select {
            width: 100%; padding: 10px; border-radius: 10px; border: 1px solid var(--border-color); background: var(--item-bg); color: var(--text-color);
            font-family: var(--font-family); font-size: 14px; -webkit-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='2' stroke='%239ca3af' class='w-6 h-6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='m19.5 8.25-7.5 7.5-7.5-7.5' /%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 10px center; background-size: 16px; cursor: pointer;
        }

        #district-list-container { flex-grow: 1; overflow: hidden; display: flex; flex-direction: column; }
        #district-list { flex-grow: 1; overflow-y: auto; padding-right: 10px; margin-right: -10px; }
        #district-list::-webkit-scrollbar { width: 5px; }
        #district-list::-webkit-scrollbar-track { background: transparent; }
        #district-list::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 10px; }

        .district-item {
            padding: 15px; border-radius: 14px; cursor: pointer; margin-bottom: 12px; border: 1px solid transparent;
            background-color: var(--item-bg); transition: all 0.25s ease; opacity: 0;
        }
        .district-item:hover { background-color: var(--item-hover-bg); transform: translateY(-3px); border-color: var(--border-color); box-shadow: 0 0 12px 0px var(--accent-color); }
        .district-item.active {
            transform: scale(1.02); background-color: var(--district-active-color); box-shadow: 0 0 20px 3px var(--district-active-color); color: white;
        }
        .district-item.active .district-name, .district-item.active .stat-label, .district-item.active .stat-value, .district-item.active .headcount-value { color: white; }
        .district-item.active .district-headcount { background-color: rgba(255,255,255,0.15); }
        .district-item.active .progress-bar { background-color: rgba(255,255,255,0.2); }

        .district-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .district-name { font-weight: 700; font-size: 18px; }
        .district-item.active .district-name { animation: text-pulse 1.5s infinite alternate; }

        .district-headcount { text-align: center; padding: 10px; border-radius: 10px; background: var(--item-hover-bg); margin-bottom: 15px; }
        .headcount-value { font-size: 24px; font-weight: 800; color: var(--accent-color); }
        .headcount-label { font-size: 11px; text-transform: uppercase; color: var(--text-muted); }

        .deployment-stats { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 12px; text-align: center; }
        .stat-value { font-weight: 800; font-size: 18px; }
        .stat-label { font-size: 11px; text-transform: uppercase; color: var(--text-muted); }

        .progress-bar { width: 100%; height: 12px; background-color: var(--border-color); border-radius: 6px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background-color: var(--success-color); border-radius: 6px; transition: width 0.8s ease-out; }

        .custom-popup .leaflet-popup-content-wrapper {
            background: var(--tooltip-bg); backdrop-filter: blur(var(--blur-intensity)); color: var(--text-color);
            border: 1px solid var(--border-color); box-shadow: 0 8px 32px 0 var(--shadow-color); border-radius: 16px; padding: 0; width: 320px;
        }
        .custom-popup .leaflet-popup-content { font-family: var(--font-family); margin: 0; animation: fade-in-scale 0.4s cubic-bezier(0.165, 0.84, 0.44, 1) forwards; }
        .custom-popup .leaflet-popup-tip { background: var(--tooltip-bg); }
        .tooltip-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); }
        .tooltip-header .district { font-size: 13px; color: var(--text-muted); font-weight: 500; }
        .tooltip-header .name { font-size: 22px; font-weight: 800; margin: 2px 0 0 0; }
        .tooltip-summary { padding: 15px 20px; display: grid; grid-template-columns: 1fr; gap: 10px; background: var(--item-bg); }
        .tooltip-summary .stat-block { text-align: center; }

        .tooltip-body { padding: 15px 20px; max-height: 200px; overflow-y: auto; }
        .tooltip-body::-webkit-scrollbar { width: 5px; }
        .tooltip-body::-webkit-scrollbar-track { background: transparent; }
        .tooltip-body::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 10px; }
        .tooltip-body h4 { font-size: 13px; margin: 0 0 10px 0; font-weight: 600; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.5px; }
        
        .trainer-entry { font-size: 14px; margin-bottom: 8px; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.03); border-left: 4px solid var(--text-muted); }
        .dark-mode .trainer-entry { background: rgba(255,255,255,0.06); }
        .trainer-name { font-weight: 700; display: block; margin-bottom: 8px; }
        .trainer-details { display: grid; grid-template-columns: auto 1fr; gap: 6px 10px; align-items: center; }
        .trainer-details i { color: var(--text-muted); width: 14px; text-align: center; }

        /* Marker Styling */
        .leaflet-marker-icon { text-shadow: 0 2px 4px rgba(0,0,0,0.3); transition: transform 0.2s ease-in-out; position: relative; }
        .leaflet-marker-icon:hover { transform: scale(1.2); }
        .district-marker .fa-map-marker-alt { font-size: 45px; }
        .tehsil-marker .fa-location-dot { font-size: 28px; }
        .live-location-circle { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 0; height: 0; border-radius: 50%; background-color: var(--marker-color); animation: pulse-circle-animation 2s infinite ease-out; opacity: 0; z-index: -1; }
        .district-marker.active-glow .fa-map-marker-alt { animation: pulse-glow 1.5s infinite alternate; }

        /* Logo Control on Map */
        .sspa-logo-container {
            position: fixed; /* Changed from absolute */
            top: 20px;
            right: 20px;
            z-index: 1001; /* Added to ensure it's above map elements */
            background: var(--sidebar-bg);
            padding: 5px;
            border-radius: 8px;
            box-shadow: 0 1px 5px var(--shadow-color);
            backdrop-filter: blur(var(--blur-intensity));
             -webkit-backdrop-filter: blur(var(--blur-intensity));
        }
        .sspa-logo-container img {
            width: 200px;
            height: auto;
            display: block;
        }

        /* Adjusted Leaflet Controls to avoid overlap with fixed elements */
        .leaflet-control-container .leaflet-top.leaflet-right {
            top: 20px; /* Adjust top to accommodate the logo control */
            right: 230px; /* Adjust right to prevent overlap with logo */
        }
        .leaflet-control-container .leaflet-bottom.leaflet-right {
            bottom: 20px;
            right: 20px;
        }

        @keyframes pulse-glow { from { filter: drop-shadow(0 0 5px var(--marker-color)); transform: scale(1.0); } to { filter: drop-shadow(0 0 20px var(--marker-color)) drop-shadow(0 0 30px var(--marker-color)); transform: scale(1.15); } }
        @keyframes text-pulse { from { color: white; text-shadow: none; } to { color: white; text-shadow: 0 0 10px rgba(255, 255, 255, 0.8), 0 0 20px rgba(255, 255, 255, 0.6); } }
        @keyframes pulse-circle-animation { from { width: 0; height: 0; opacity: 0.7; } to { width: 100px; height: 100px; opacity: 0; } }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes gradient-pan { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fade-in-scale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div id="map-container"> <div id="map"></div> </div>
        <div id="sidebar">
            <div class="sidebar-header">
                <div>
                    <h1>DFLT-2 | SSPA Districts</h1>
                    <p class="subtitle" id="sidebar-subtitle">Developed by Center of Adaptive Social Protection & Economic Empowerment - SDPI</p>
                </div>
                <button id="theme-toggle" title="Toggle Dark Mode"><i class="fa-solid fa-moon"></i></button>
            </div>
            <div class="sidebar-section-header"><i class="fa-solid fa-chart-pie"></i>Overall Progress</div>
            <div id="overview-stats"></div>
            <div class="sidebar-filters">
                <div class="filter-group">
                    <label for="district-filter">District</label>
                    <select id="district-filter"></select>
                </div>
                <div class="filter-group">
                    <label for="rural-urban-filter">Classification</label>
                    <select id="rural-urban-filter">
                        <option value="All">All</option>
                        <option value="Rural">Rural</option>
                        <option value="Urban">Urban</option>
                    </select>
                </div>
            </div>
            <div id="district-list-container">
                <div class="sidebar-section-header"><i class="fa-solid fa-map-location-dot"></i>District Deployment</div>
                <div id="district-list"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            
            // --- HARDCODED DATA SOURCE ---
            // NOTE: Data is hardcoded as browsers cannot access local file paths for security reasons.
            const CSV_DATA = `District,Tehsil,Rural / Urban,Total Head_Count,Name,Phone Number,Status with BISP,Considered Headcount,Formula_Consideration,Trainers Needed,Selected,Comment
Badin,Badin,Urban,"21,213",Ruqayya,3312193086,SUPERVISOR,10607,,36,1,4 Pairs Vacant
Badin,Badin,Urban,"21,213",Fazila,3336471698,USHER,,,,1,
Badin,Golarchi,Rural,"11,960",Jaivanti Parmar,3442397334,SUPERVISOR,,,,1,
Badin,Golarchi,Rural,"11,960",Amber,3470136108,USHER,6300,,,1,
Badin,Matli,Rural,"14,231",Azra,3063540655,CRM,8400,,,1,3 Pairs Vacant
Badin,Matli,Rural,"14,231",Saima,3113859151,CRM,,,,1,
Badin,Talhar,Rural,"10,330",Kanwal,3413709654,ASPC,6300,24.09,,1,
Badin,Talhar,Rural,"10,330",Madiha,3442383504/3453535971,CRM,,,,1,
Badin,Tando Bago,Rural,"13,803",Bushra,3310281733,ASPC,,60.28,,1,
Badin,Tando Bago,Rural,"13,803",Zakia,3073251824/3332525288,CRM,6300,,,1,3 Trainers Vacant
Badin,Tando Bago,Rural,"13,803",Sadia,3432391291,USHER,,,,1,
Ghotki,Daharki,Rural,"7,311",Musarat Bhutto,3183438942,ASPC,,65.3,2,,
Ghotki,Mirpur Mathelo,Urban,"21,335",Mehnaz,3013250345,ASPC,,60.3,,1,
Ghotki,Mirpur Mathelo,Urban,"21,335",Asia Alas Papi,3268933265,CRM,2100,,,1,
Jacobabad,Garhi Khairo,Rural,"8,386",Surya Begam,3334477318,ASPC,,56.01,5,1,
Jacobabad,Garhi Khairo,Rural,"8,386",Nasreen,3362858165,CRM,2100,,,1,
Jacobabad,Jacobabad,Urban,"18,145",Shenaz,3173305697,ASPC,1050,53.89,,1,
Jacobabad,Thul,Rural,"26,393",Ambreen,3138117685,CRM,2100,,,1,
Jacobabad,Thul,Rural,"26,393",Asma Sarki,3033992194,CRM,,,,1,
Kambar Shahdadkot,Kambar Ali Khan,Urban,"16,071",Najima Solangi,3243752579,ASPC,1050,54.73,13,1,
Kambar Shahdadkot,Miro Khan,Rural,"6,986",Ghulaam Kaneez,3063749722,CRM,,,,1,
Kambar Shahdadkot,Miro Khan,Rural,"6,986",Nijhana Parveen,3029787618,CRM,2100,,,1,
Kambar Shahdadkot,Nasirabad,Rural,"7,336",Iram Tunio,3102756743,ASPC,,57.84,,1,
Kambar Shahdadkot,Nasirabad,Rural,"7,336",Noor Un Nisa,3273421840,CRM,,,,1,
Kambar Shahdadkot,Nasirabad,Rural,"7,336",Zoya Qurban,3272233825,CRM,3150,,,1,
Kambar Shahdadkot,Qubo Saeed Khan,Rural,261,Parveen Magsi,3342557534,ASPC,,No documentation provided,,1,
Kambar Shahdadkot,Qubo Saeed Khan,Rural,261,Noor Jahan,3342863871,CRM,2100,,,1,
Kambar Shahdadkot,Shahdadkot,Urban,"4,909",Rehana Chandio,3302937448,CRM,2100,,,1,
Kambar Shahdadkot,Shahdadkot,Urban,"4,909",Sidra Nizam,3323078753,CRM,,,,1,
Kambar Shahdadkot,Sujawal Junejo,Rural,"6,530",Mala,3161324935,CRM,2100,,,1,
Kambar Shahdadkot,Sujawal Junejo,Rural,"6,530",Saima,3134654484,CRM,,,,1,
Kambar Shahdadkot,Warah,Rural,"10,789",Zumra Rehman,3426481799,ASPC,1050,No documentation provided,,1,
Kashmore,Kandhkot,Urban,"12,555",Saira Ameer,3337304731,CRM,,,2,,
Kashmore,Kashmore,Urban,"20,229",Maryam Bano,3337363182,ASPC,,Error: Bachelor without FSc,,1,
Kashmore,Kashmore,Urban,"20,229",Ghulam Qubra,3354139964,CRM,2100,,,1,
Matiari,Hala,Rural,"9,540",Aqeela Memon,3351288252,ASPC,,Error: Bachelor without FSc,5,1,
Matiari,Hala,Rural,"9,540",Samreen N/A,3133643010,CRM,2100,,,1,
Matiari,Matiari,Urban,"12,149",Tahmeena,3083360771,ASPC,1050,54.17,,1,
Matiari,Saeedabad,Rural,"7,528",Raheela Jamali,3023206099,ASPC,,38.4,,1,
Matiari,Saeedabad,Rural,"7,528",Shahida Keerio,3053970475,CRM,2100,,,1,
Mirpur Khas,Digri,Rural,"7,628",Musarat Taj,3083528430,ASPC,,57.86,24,1,
Mirpur Khas,Digri,Rural,"7,628",Sadaf,3013286800,SUPERVISOR,3150,,,1,
Mirpur Khas,Hussain Bux Mari,Rural,"8,436",Khalida,3208340500,CRM,,,,1,
Mirpur Khas,Hussain Bux Mari,Rural,"8,436",Murk Muhammad Rafiq,3233445133,SUPERVISOR,2100,,,1,
Mirpur Khas,Jhudo,Rural,"9,122",Taskeen,3082416266,ASPC,,35.73,,1,
Mirpur Khas,Jhudo,Rural,"9,122",Saba Talpur,3313919704,CRM,,,,1,
Mirpur Khas,Jhudo,Rural,"9,122",Sultana,3456163148,CRM,4200,,,1,
Mirpur Khas,Kot Ghulam Muhammad,Rural,"10,133",Aneesa,3013857744,CRM,4200,,,1,
Mirpur Khas,Kot Ghulam Muhammad,Rural,"10,133",Ganga,3452382735,CRM,,,,1,
Mirpur Khas,Mirpur Khas,Urban,"5,518",Haneefa Soomro,3362236886,ASPC,,34.57,,1,
Mirpur Khas,Mirpur Khas,Urban,"5,518",Noor Jahan,3472363649,CRM,3150,,,1,
Mirpur Khas,Mirpur Khas,Urban,"5,518",Tehmina,3103862906,CRM,,,,1,
Mirpur Khas,Shujaabad,Rural,"8,524",Areeba,3110366929,CRM,,,,1,
Mirpur Khas,Shujaabad,Rural,"8,524",Bibo,3063318263,CRM,,,,1,
Mirpur Khas,Shujaabad,Rural,"8,524",Nimra Bibi,3040159414,CRM,,,,1,
Mirpur Khas,Shujaabad,Rural,"8,524",Sadia Qasim,3246351539,CRM,4200,,,1,
Mirpur Khas,Sindhri,Rural,"12,047",Hifsa,3181397662,CRM,4200,,,1,
Mirpur Khas,Sindhri,Rural,"12,047",Keenjhar,3121334981,CRM,,,,1,
Sanghar,Jam Nawaz Ali,Rural,"8,045",Afroz,3063904408,CRM,4200,,40,1,
Sanghar,Jam Nawaz Ali,Rural,"8,045",Ishrat,3002044877,CRM,,,,1,
Sanghar,Khipro,Rural,"14,052",Nida Mohsin,3245052149,ASPC,8400,No documentation provided,,1,
Sanghar,Khipro,Rural,"14,052",Maryam,3004107395,CRM,,,,1,
Sanghar,Sanghar,Urban,"17,002",Shabana Khaskhali,3327956273,CRM,8400,,,1,
Sanghar,Sanghar,Urban,"17,002",Shazma Shahid Ali,3262709750,CRM,,,,1,
Sanghar,Shahdadpur,Urban,"13,152",Shehrish Arain,3173192907,CRM,6400,,,1,
Sanghar,Shahdadpur,Urban,"13,152",Zainab,3142651344,CRM,,,,1,
Sanghar,Sinjhoro,Rural,"14,786",Shazia Laghari,3265132667,ASPC,8400,No documentation provided,,1,
Sanghar,Tando Adam,Urban,"10,194",Muzamil,3113253547,ASPC,6400,58.41,,1,
Sanghar,Tando Adam,Urban,"10,194",Parvish,3013553965,CRM,,,,1,
Shikarpur,Garhi Yasin,Rural,"3,895",Asma,3103450131,CRM,,,2,,
Shikarpur,Shikarpur,Urban,"8,424",Nadiya,3072772488,ASPC,,55.01,,1,
Shikarpur,Shikarpur,Urban,"8,424",Adeela Shah,3363373360,SUPERVISOR,2100,,,1,
Sujawal,Jati,Rural,"6,368",Ruksar,3417119804,ASPC,4200,No documentation provided,17,1,
Sujawal,Jati,Rural,"6,368",Khalida,3113818821,SUPERVISOR,,,,1,
Sujawal,Mirpur Bathoro,Rural,"7,803",Aiman,3123756000,ASPC,,No documentation provided,,1,
Sujawal,Mirpur Bathoro,Rural,"7,803",Shaheen,3063485108,CRM,4200,,,1,
Sujawal,Shah Bunder,Rural,"3,777",Ayesha Ummrani,0320-3645928,ASPC,,Error: Master without Bachelor,,1,
Sujawal,Shah Bunder,Rural,"3,777",Shaista,3100304134,SUPERVISOR,3150,,,1,
Sujawal,Shah Bunder,Rural,"3,777",Amna Parveen,3173608578,USHER,,,,1,
Sujawal,Sujawal,Urban,"8,238",Saima,3134654484,ASPC,,No documentation provided,,1,
Sujawal,Sujawal,Urban,"8,238",Mala,3161324935,CRM,6300,,,1,
Tando Allah Yar,Chamber,Rural,"11,593",Ameena Jalbani,3443696459,CRM,,,7,1,
Tando Allah Yar,Chamber,Rural,"11,593",Nabeela Kanwal,3073127691,CRM,2100,,,1,
Tando Allah Yar,Jhando Mari,Rural,"11,432",Benazir N/A,3312091846,ASPC,,No documentation provided,,1,
Tando Allah Yar,Jhando Mari,Rural,"11,432",Rukhsana,3013285945,ASPC,,Error: FSc without Matric,,1,
Tando Allah Yar,Jhando Mari,Rural,"11,432",Shahneela Dilshaad Ali,3332386192,CRM,3150,,,1,
Tando Allah Yar,Tando Allah Yar,Urban,"9,405",Sumiya Patoli,3363907047,CRM,2100,,,1,
Tando Allah Yar,Tando Allah Yar,Urban,"9,405",Tasleem Fatima,3130696886,CRM,,,,1,
Tando Muhammad Khan,Bulri Shah Karim,Rural,"13,101",Sameena N/A,3483348951,ASPC,1050,No documentation provided,5,1,
Tando Muhammad Khan,Tando Ghulam Hyder,Rural,"5,816",Shameem Aara,3408545930,ASPC,,Error: Bachelor without FSc,,1,
Tando Muhammad Khan,Tando Ghulam Hyder,Rural,"5,816",Qumer Ul Nissa,3423318697,CRM,2100,,,1,
Tando Muhammad Khan,Tando Muhammad Khan,Urban,"9,973",Bharti Kumari,3102746204,ASPC,,Error: Master without Bachelor,,1,
Tando Muhammad Khan,Tando Muhammad Khan,Urban,"9,973",Zahida Bashir,3133695751,CRM,2100,,,1,
Tharparkar,Chachro,Rural,"11,308",Naziran,3412864765,CRM,6300,,34,1,
Tharparkar,Chachro,Rural,"11,308",Aisha,3413943509,SUPERVISOR,,,,1,
Tharparkar,Dahli,Rural,"3,962",Aklan,3402436629,ASPC,2100,No documentation provided,,1,
Tharparkar,Dahli,Rural,"3,962",Najma,3428493680/3423350355,CRM,,,,1,
Tharparkar,Diplo,Rural,"5,872",Sumaya,3362843814/03363643028,ASPC,,No documentation provided,,1,
Tharparkar,Diplo,Rural,"5,872",Bakhtawar,3457433648,CRM,2100,,,1,
Tharparkar,Islamkot,Rural,"14,600",Tahseen,3488301681,ASPC,6300,No documentation provided,,1,
Tharparkar,Islamkot,Rural,"14,600",Geeta Devi,3122595310,CRM,,,,1,
Tharparkar,Kaloi,Rural,"9,369",Rahim Zadi,3431313512,ASPC,4300,No documentation provided,,1,
Tharparkar,Kaloi,Rural,"9,369",Sangeeta Bai,3013243077,CRM,,,,1,
Tharparkar,Mithi,Urban,"13,074",Geeta Bai,3337108835,CRM,,,,1,
Tharparkar,Mithi,Urban,"13,074",Samreen,3473700090,CRM,8400,,,1,
Tharparkar,Nagar Parkar,Rural,"13,026",Sheela,3496889338,SUPERVISOR,6300,,,1,
Tharparkar,Nagar Parkar,Rural,"13,026",Pawan Kanweer,3433919164,USHER,,,,1,
Thatta,Ghorabari,Rural,"4,418",Najma,3047983016,CRM,,,18,1,
Thatta,Ghorabari,Rural,"4,418",Samina,3243571906,CRM,2100,,,1,
Thatta,Keti Bunder,Rural,692,Sana,3310327436,ASPC,,33.71,,1,
Thatta,Keti Bunder,Rural,692,Aysha Pervez,3243526981,CRM,2100,,,1,
Thatta,Mirpur Sakro,Rural,"11,857",Fahmida Batool,3012011264,ASPC,,59.03,,1,
Thatta,Mirpur Sakro,Rural,"11,857",Maira,3423348861,CRM,6300,,,1,
Thatta,Thatta,Urban,"11,805",Nasreen,3101633110,ASPC,8400,33.59,,1,
Thatta,Thatta,Urban,"11,805",Nayab,3183129503,SUPERVISOR,,,,1,
Umer Kot,Kunri,Rural,"13,088",Tanveer Kausar,3362914950,CRM,6300,,30,1,
Umer Kot,Kunri,Rural,"13,088",Shazia Abdul Ghaffar,3066414128,SUPERVISOR,,,,1,
Umer Kot,Pithoro,Rural,"11,045",Nisha,3363314569,ASPC,,Error: FSc without Matric,,1,
Umer Kot,Pithoro,Rural,"11,045",Saveeta,3323411330/3362826213,CRM,6300,,,1,
Umer Kot,Samaro,Rural,"8,045",Raveena,3322284989,ASPC,,58.24,,1,
Umer Kot,Samaro,Rural,"8,045",Sania,3420356595,CRM,4300,,,1,
Umer Kot,Umer Kot,Urban,"29,453",Rekha Bai,3330272015,ASPC,14700,Error: Master without Bachelor,,1,
Umer Kot,Umer Kot,Urban,"29,453",Zara Amjad,3322648430,ASPC,,Error: FSc without Matric,,1,
`;
            
            const sspaLogoBase64 = "https://www.sdpi.org/assets/images/sdpi-logo-2020.webp";

            const districtSummaries = {
                "Badin": { headcount: 37907, contracted: 11, totalTrainers: 36 }, "Ghotki": { headcount: 2100, contracted: 2, totalTrainers: 2 },
                "Jacobabad": { headcount: 5250, contracted: 5, totalTrainers: 5 }, "Kambar Shahdadkot": { headcount: 13650, contracted: 13, totalTrainers: 13 },
                "Kashmore": { headcount: 2100, contracted: 2, totalTrainers: 2 }, "Matiari": { headcount: 5250, contracted: 5, totalTrainers: 5 },
                "Mirpur Khas": { headcount: 25200, contracted: 18, totalTrainers: 24 }, "Sanghar": { headcount: 42200, contracted: 11, totalTrainers: 40 },
                "Shikarpur": { headcount: 2100, contracted: 2, totalTrainers: 2 }, "Sujawal": { headcount: 17850, contracted: 9, totalTrainers: 17 },
                "Tando Allah Yar": { headcount: 7350, contracted: 7, totalTrainers: 7 }, "Tando Muhammad Khan": { headcount: 5250, contracted: 5, totalTrainers: 5 },
                "Tharparkar": { headcount: 35800, contracted: 14, totalTrainers: 34 }, "Thatta": { headcount: 18900, contracted: 8, totalTrainers: 18 },
                "Umer Kot": { headcount: 31600, contracted: 8, totalTrainers: 30 }
            };

            for (const key in districtSummaries) {
                if (districtSummaries.hasOwnProperty(key)) {
                    districtSummaries[key].contracted = districtSummaries[key].totalTrainers;
                }
            }

            const initialTehsilCoords = {
                "BADIN": [24.65, 68.83], "GOLARCHI": [24.60, 68.75], "MATLI": [25.03, 68.65], "TALHAR": [24.84, 68.80], "TANDO BAGO": [24.79, 69.00],
                "DAHARKI": [27.97, 69.51], "GHOTKI": [28.02, 69.32], "KHANGARH": [27.87, 69.41], "MIRPUR MATHELO": [27.85, 69.55], "UBAURO": [28.16, 69.73],
                "GARHI KHAIRO": [28.05, 67.98], "JACOBABAD": [28.28, 68.44], "THUL": [28.24, 68.77],
                "KAMBAR ALI KHAN": [27.58, 67.98], "MIRO KHAN": [27.76, 68.09], "NASIRABAD": [27.38, 67.91], "QUBO SAEED KHAN": [27.95, 67.88], "SHAHDADKOT": [27.84, 67.91], "SUJAWAL JUNEJO": [27.50, 68.06], "WARAH": [27.44, 67.79],
                "KANDHKOT": [28.24, 69.18], "KASHMORE": [28.43, 69.58], "TANGWANI": [28.32, 69.33],
                "HALA": [25.82, 68.41], "MATIARI": [25.59, 68.45], "SAEEDABAD": [26.04, 68.27],
                "DIGRI": [25.15, 69.11], "HUSSAIN BUX MARI": [25.75, 69.10], "JHUDO": [24.96, 69.31], "KOT GHULAM MUHAMMAD": [25.30, 69.28], "MIRPUR KHAS": [25.52, 69.01], "SHUJAABAD": [25.43, 69.08], "SINDHRI": [25.71, 69.08],
                "JAM NAWAZ ALI": [25.86, 69.21], "KHIPRO": [26.00, 69.38], "SANGHAR": [26.04, 68.95], "SHAHDADPUR": [26.15, 68.64], "SINJHORO": [26.24, 68.81], "TANDO ADAM": [25.77, 68.66],
                "GARHI YASIN": [27.90, 68.51], "KHANPUR": [27.83, 68.41], "LAKHI": [27.86, 68.67], "SHIKARPUR": [27.95, 68.63],
                "JATI": [24.35, 68.26], "KHARO CHAN": [24.12, 67.55], "MIRPUR BATHORO": [24.73, 68.26], "SHAH BUNDER": [24.18, 67.90], "SUJAWAL": [24.60, 68.07],
                "CHAMBER": [25.29, 68.80], "JHANDO MARI": [25.55, 68.72], "NASARPUR": [25.51, 68.63], "TANDO ALLAH YAR": [25.46, 68.71],
                "BULRI SHAH KARIM": [25.04, 68.45], "TANDO GHULAM HYDER": [25.07, 68.74], "TANDO MUHAMMAD KHAN": [25.12, 68.53],
                "CHACHRO": [25.11, 70.25], "DAHLI": [24.59, 70.43], "DIPLO": [24.46, 69.58], "ISLAMKOT": [24.70, 70.17], "KALOI": [24.81, 69.83], "MITHI": [24.74, 69.80], "NAGAR PARKAR": [24.35, 70.75],
                "GHORABARI": [24.51, 67.92], "KETI BUNDER": [24.14, 67.45], "MIRPUR SAKRO": [24.54, 67.63], "THATTA": [24.74, 67.92],
                "KUNRI": [25.20, 69.55], "PITHORO": [25.52, 69.38], "SAMARO": [25.29, 69.41], "UMER KOT": [25.35, 69.73]
            };

            const map = L.map('map', { center: [27.5, 68.5], zoom: 7, zoomControl: false });
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            const cartoLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO' }).addTo(map);
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '&copy; Esri' });
            
            // Moved this control to prevent overlap with the fixed logo
            L.control.layers({ "Street View": cartoLayer, "Satellite View": satelliteLayer }, null, { position: 'topright' }).addTo(map);

            const LogoControl = L.Control.extend({
                onAdd: function(map) {
                    const container = L.DomUtil.create('div', 'sspa-logo-container');
                    container.innerHTML = `<img src="${sspaLogoBase64}" alt="SSPA Logo"/>`;
                    return container;
                }
            });
            new LogoControl({ position: 'topright' }).addTo(map);

            const districtFilter = document.getElementById('district-filter');
            const ruralUrbanFilter = document.getElementById('rural-urban-filter');
            const districtListContainer = document.getElementById('district-list');
            const overviewStatsContainer = document.getElementById('overview-stats');
            const layers = { districts: L.layerGroup().addTo(map), tehsils: L.layerGroup().addTo(map), lines: L.layerGroup().addTo(map) };
            let allProcessedData = {}, grandTotals = {}, activeDistrictMarker = null;

            function parseCSV(csv) {
                const lines = csv.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                const result = [];
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    const obj = {};
                    const values = lines[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                    for (let j = 0; j < headers.length; j++) {
                        let value = (values[j] || '').trim();
                        if (value.startsWith('"') && value.endsWith('"')) value = value.slice(1, -1);
                        obj[headers[j]] = value;
                    }
                    result.push(obj);
                }
                return result;
            }

            function loadData() {
                const data = {};
                const rows = parseCSV(CSV_DATA);

                rows.forEach(row => {
                    const { District, Tehsil } = row;
                    if (!District || !Tehsil) return;

                    if (!data[District]) {
                        data[District] = { name: District, tehsils: {} };
                    }
                    if (!data[District].tehsils[Tehsil]) {
                        data[District].tehsils[Tehsil] = {
                            name: Tehsil, district: District, coords: initialTehsilCoords[Tehsil.toUpperCase()] || null,
                            // MODIFICATION: Added ruralUrban property to each tehsil
                            ruralUrban: row['Rural / Urban'],
                            trainers: [], totalTrainers: 0, contracted: 0
                        };
                    }

                    const tehsilData = data[District].tehsils[Tehsil];
                    tehsilData.trainers.push({
                        name: row['Name'], phone: row['Phone Number'], status: row['Status with BISP'],
                        ruralUrban: row['Rural / Urban'], comment: row['Comment']
                    });
                    
                    const needed = parseInt(row['Trainers Needed'], 10);
                    if (!isNaN(needed) && needed > 0) tehsilData.totalTrainers = needed;
                    
                    const selected = parseInt(row['Selected'], 10);
                    if (selected === 1) tehsilData.contracted++;
                });

                allProcessedData = data;
                
                Object.keys(allProcessedData).sort().forEach((name, index) => {
                    allProcessedData[name].color = `hsl(${(index * 137.508) % 360}, 70%, 60%)`;
                });
                
                calculateGrandTotals();
                return true;
            }

            function calculateGrandTotals() {
                grandTotals = {
                    headcount: Object.values(districtSummaries).reduce((sum, s) => sum + s.headcount, 0),
                    contracted: Object.values(districtSummaries).reduce((sum, s) => sum + s.contracted, 0),
                    totalTrainers: Object.values(districtSummaries).reduce((sum, s) => sum + s.totalTrainers, 0)
                };
            }

            function initializeDashboard() {
                populateFilters();
                addEventListeners();
                updateDisplay();
            }

            function populateFilters() {
                const districtNames = ['All', ...Object.keys(allProcessedData).sort()];
                districtFilter.innerHTML = districtNames.map(d => `<option value="${d}">${d}</option>`).join('');
            }

            function addEventListeners() {
                districtFilter.addEventListener('change', () => {
                    updateDisplay();
                    if (districtFilter.value !== 'All') highlightDistrict(districtFilter.value);
                });
                ruralUrbanFilter.addEventListener('change', updateDisplay);
                document.getElementById('theme-toggle').addEventListener('click', () => {
                    document.body.classList.toggle('dark-mode');
                    const icon = document.querySelector('#theme-toggle i');
                    icon.classList.toggle('fa-moon', !document.body.classList.contains('dark-mode'));
                    icon.classList.toggle('fa-sun', document.body.classList.contains('dark-mode'));
                });
            }

            function updateOverviewPanel() {
                overviewStatsContainer.innerHTML = `
                    <div class="overview-stat"><div class="overview-stat-value">${grandTotals.headcount.toLocaleString()}</div><div class="overview-stat-label">Considered Headcount</div></div>
                    <div class="overview-stat"><div class="overview-stat-value">${grandTotals.totalTrainers.toLocaleString()}</div><div class="overview-stat-label">Total Deployed ASPCs</div></div>
                `;
            }

            // MODIFICATION: Main display logic updated to handle filters
            function updateDisplay() {
                ['districts', 'tehsils', 'lines'].forEach(layer => layers[layer].clearLayers());
                districtListContainer.innerHTML = '';
                activeDistrictMarker = null;

                const selectedDistrict = districtFilter.value;
                const selectedClassification = ruralUrbanFilter.value;

                const districtsToDisplay = Object.values(allProcessedData)
                    .filter(d => selectedDistrict === 'All' || d.name === selectedDistrict);

                districtsToDisplay.forEach((district, index) => {
                    // Filter tehsils based on the classification dropdown
                    const filteredTehsils = Object.values(district.tehsils).filter(tehsil => 
                        selectedClassification === 'All' || tehsil.ruralUrban === selectedClassification
                    );

                    // Only show district in the sidebar if it has tehsils matching the filter
                    if (filteredTehsils.length > 0) {
                        populateDistrictList(district, index);
                        filteredTehsils.forEach(tehsil => {
                            if (tehsil.coords) createTehsilMarker(tehsil, district.color);
                        });
                    }
                });
                
                updateOverviewPanel();

                if (selectedDistrict === 'All') {
                    map.flyTo([27.5, 68.5], 7);
                } else {
                    const bounds = Object.values(allProcessedData[selectedDistrict].tehsils)
                        .map(t => t.coords).filter(Boolean);
                    if (bounds.length > 0) map.fitBounds(bounds, { padding: [50, 50], maxZoom: 14 });
                }
            }

            // MODIFICATION: Tehsil markers now use different icons
            function createTehsilMarker(tehsil, districtColor) {
                // Choose icon based on Rural/Urban status
                const iconClass = tehsil.ruralUrban === 'Urban' ? 'fa-city' : 'fa-tree';
                const iconHtml = `<i class="fa-solid ${iconClass}" style="font-size: 28px; color: ${districtColor}; text-shadow: 0 2px 4px rgba(0,0,0,0.5);"></i>`;
                
                const tehsilIcon = L.divIcon({
                    className: 'leaflet-marker-icon tehsil-marker',
                    html: iconHtml,
                    iconSize: [28, 28],
                    iconAnchor: [14, 28]
                });
                const marker = L.marker(tehsil.coords, { icon: tehsilIcon }).addTo(layers.tehsils);
                marker.bindPopup(() => createTehsilPopupContent(tehsil, districtColor), { className: 'custom-popup', offset: [0, -15] });
                marker.on('click', () => highlightDistrict(tehsil.district));
            }

            // MODIFICATION: Popup content now includes Rural/Urban status
            function createTehsilPopupContent(tehsil, color) {
                const trainersHtml = tehsil.trainers.map(t => `
                    <div class="trainer-entry">
                        <span class="trainer-name">${t.name}</span>
                        <div class="trainer-details">
                            <i class="fa-solid fa-phone"></i><span>${t.phone}</span>
                        </div>
                    </div>`).join('');
                
                const totalDeployed = tehsil.totalTrainers > 0 ? tehsil.totalTrainers : tehsil.contracted;
                const iconClass = tehsil.ruralUrban === 'Urban' ? 'fa-city' : 'fa-tree';

                return `
                    <div class="tooltip-header">
                        <div class="district">${tehsil.district} &mdash; <i class="fa-solid ${iconClass}"></i> ${tehsil.ruralUrban}</div>
                        <h3 class="name" style="color:${color};">${tehsil.name}</h3>
                    </div>
                    <div class="tooltip-summary">
                        <div class="stat-block"><div class="stat-value">${totalDeployed}</div><div class="stat-label">Deployed ASPCs</div></div>
                    </div>
                    <div class="tooltip-body"><h4>ASPCs Details</h4>${trainersHtml}</div>`;
            }

            function highlightDistrict(districtName) {
                document.querySelectorAll('.district-item').forEach(item => {
                    item.classList.remove('active');
                    item.style.removeProperty('--district-active-color');
                });
                layers.lines.clearLayers();
                
                const listItem = document.querySelector(`.district-item[data-district-name="${districtName}"]`);
                const districtData = allProcessedData[districtName];
                if (!districtData) return;

                if (listItem) {
                    listItem.classList.add('active');
                    listItem.style.setProperty('--district-active-color', districtData.color);
                    listItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                const tehsilsWithCoords = Object.values(districtData.tehsils).filter(t => t.coords);
                if (tehsilsWithCoords.length > 0) {
                    const districtCenter = tehsilsWithCoords[0].coords;
                    tehsilsWithCoords.forEach(tehsil => L.polyline([districtCenter, tehsil.coords], { color: districtData.color, weight: 2, opacity: 0.7, dashArray: '5, 10' }).addTo(layers.lines));
                }
                
                districtFilter.value = districtName;
            }

            function populateDistrictList(district, index) {
                const summary = districtSummaries[district.name] || { headcount: 0, contracted: 0, totalTrainers: 0 };
                const progress = summary.totalTrainers > 0 ? (summary.contracted / summary.totalTrainers) * 100 : 0;

                const item = document.createElement('div');
                item.className = 'district-item';
                item.dataset.districtName = district.name;
                item.style.animation = `fade-in-up 0.5s ${index * 0.04}s ease-out forwards`;
                
                item.innerHTML = `
                    <div class="district-header">
                        <div class="district-name">${district.name}</div>
                    </div>
                    <div class="district-headcount">
                        <div class="headcount-value">${summary.headcount.toLocaleString()}</div>
                        <div class="headcount-label">Considered Headcount</div>
                    </div>
                    <div class="deployment-stats">
                        <div class="stat-block">
                            <div class="stat-value">${summary.contracted}</div>
                            <div class="stat-label">Total Deployed</div>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-bar-fill" style="width: ${progress}%; background-color:${district.color};"></div>
                    </div>
                `;

                item.addEventListener('click', () => {
                    highlightDistrict(district.name);
                    const bounds = Object.values(district.tehsils).map(t => t.coords).filter(Boolean);
                    if (bounds.length > 0) map.fitBounds(bounds, { padding: [50, 50] });
                });
                districtListContainer.appendChild(item);
            }

            // --- INITIALIZATION ---
            if (loadData()) initializeDashboard();
        });
    </script>
</body>
</html>