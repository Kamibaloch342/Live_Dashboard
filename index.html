<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DFLT Phase 2 Dashboard</title>

    <!-- Tailwind CSS for utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet for the interactive map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

    <!-- Chart.js for all graphs and charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <!-- Google Font (Montserrat) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        /* Custom CSS Variables for easy theme management */
        :root {
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --border-color: #dee2e6;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --bar-bg: #e9ecef;
            
            /* Custom colors for bar segments */
            --c-valid: #28a745;
            --c-fake: #ffc107;
            --c-age1: #0d6efd;
            --c-age2: #6f42c1;
            --c-age3: #17a2b8;
            --c-age4: #6c757d;
            --c-training: #0d6efd;
            --c-handbooks: #20c997;
        }

        /* Base styles for body and font */
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-color);
            background-image: linear-gradient(175deg, #f8f9fa 0%, #e9ecef 100%);
            color: var(--text-primary);
            overflow: hidden; /* Prevent scrollbars from showing due to initial animations */
        }

        /* Main dashboard grid layout using CSS Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-template-rows: 60px repeat(10, minmax(0, 1fr)); /* Header + 10 rows for content */
            gap: 1rem;
            height: 100vh; /* Full viewport height */
            padding: 1rem;
            box-sizing: border-box; /* Include padding in element's total width and height */
        }

        /* Styling for all dashboard cards with animations and shadows */
        .card {
            background-color: rgba(255, 255, 255, 0.9); /* Slightly transparent background */
            backdrop-filter: blur(10px); /* Frosted glass effect */
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.5s ease-out forwards; /* Fade-in animation */
            color: var(--text-primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* Soft shadow */
            min-height: 0; /* Allow cards to shrink as needed */
        }

        /* Ensure Montserrat font and correct text color for all relevant elements */
        h1, h2, h3, h4, p, span, div, label, select, button, table, th, td {
            font-family: 'Montserrat', sans-serif !important;
            color: var(--text-primary);
        }
        /* Specific color overrides for Tailwind classes to ensure light mode compatibility */
        .text-white { color: var(--text-primary) !important; }
        .text-gray-400 { color: var(--text-secondary) !important; }
        .text-gray-200 { color: #374151 !important; }
        .text-gray-300 { color: #4b5563 !important; }
        .text-gray-500 { color: var(--text-secondary) !important; }
        .text-red-400 { color: #ef4444 !important; }
        .text-yellow-400 { color: #facc15 !important; }
        .text-indigo-400 { color: #6366f1 !important; }
        .text-teal-400 { color: #2dd4bf !important; }
        .text-indigo-300 { color: #818cf8 !important; }


        /* Keyframe animation for general fade-in effect */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Grid placement for main sections */
        .header {
            grid-column: 1 / -1; /* Spans all columns */
            grid-row: 1; /* First row */
            background-color: var(--card-bg);
        }
        .map-card {
            grid-column: 1 / 8; /* Spans 7 columns */
            grid-row: 2 / 8; /* Spans rows 2 to 7 */
            position: relative;
        }
        .kpi-main {
            grid-column: 8 / 13; /* Spans 5 columns */
            grid-row: 2 / 4; /* Spans rows 2 to 3 */
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3 columns for KPIs */
            gap: 1rem;
            background-color: transparent; /* Remove background for this container */
            border: none;
            box-shadow: none;
            padding: 0;
        }
        .kpi-main .card {
            background-color: rgba(255, 255, 255, 0.9); /* Individual KPI cards retain background */
            justify-content: center;
        }

        .provincial-summary-card {
            grid-column: 8 / 13; /* Spans 5 columns */
            grid-row: 4 / 8; /* Spans rows 4 to 7 */
            display: flex;
            flex-direction: column;
            padding: 1rem;
            overflow-y: hidden; /* Hide scrollbar for the entire card, its content will scroll */
        }
        /* Specific content area within provincial summary card for scrolling */
        #provincialSummaryContent {
            flex-grow: 1;
            overflow-y: auto; /* Enable scrolling for content */
        }


        .monthly-trend-card {
            grid-column: 1 / 5; /* Spans 4 columns */
            grid-row: 8 / 12; /* Spans rows 8 to 11 */
        }
        .provincial-ranking-card {
            grid-column: 5 / 9; /* Spans 4 columns */
            grid-row: 8 / 12;
        }
        .leaderboard-card {
            grid-column: 9 / 13; /* Spans 4 columns */
            grid-row: 8 / 12;
        }

        /* Leaflet map styling */
        #map {
            height: 100%;
            width: 100%;
            border-radius: 0.5rem;
            z-index: 0; /* Ensure map is behind other elements */
        }
        /* Light mode popups for Leaflet */
        .leaflet-popup-content-wrapper {
            background-color: #fff;
            color: #1f2937;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-family: 'Montserrat', sans-serif !important;
        }
        .leaflet-popup-tip { background-color: #fff; }
        .leaflet-popup-content-wrapper * { font-family: 'Montserrat', sans-serif !important; color: #1f2937; }

        /* Chart.js specific styling (for monthly trend) */
        .chart-container {
            flex-grow: 1; /* Allow chart to take available space */
            position: relative;
            min-height: 0; /* Prevent flex item from overflowing */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
        }

        /* Table container for scrolling content within cards */
        .table-container {
            flex-grow: 1;
            overflow-y: auto; /* Enable scrolling for table content */
            min-height: 0;
        }
        /* Custom scrollbar styling for better aesthetics */
        .table-container::-webkit-scrollbar { width: 6px; }
        .table-container::-webkit-scrollbar-track { background: transparent; }
        .table-container::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 10px; }
        .table-container thead {
            background-color: #e5e7eb;
            position: sticky; /* Keep header visible on scroll */
            top: 0;
            z-index: 1;
        }

        /* Provincial Summary Card Specific Styles (for Chart.js based graphs) */
        .province-metric-item {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            background-color: rgba(243, 244, 246, 0.5); /* Light background for metric items */
            border: 1px solid #f3f4f6;
            height: 100%;
            min-height: 120px;
        }
        .province-metric-item .chart-container {
            flex-grow: 1;
            width: 100%;
            min-height: 80px;
        }
        .province-metric-item canvas {
            max-height: 100%;
            max-width: 100%;
        }

        /* Province filter buttons styling (removed from HTML) */
        .province-button {
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            background-color: #d1d5db;
            color: #374151;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid #cbd5e1;
            transition: all 0.2s ease-in-out;
        }
        .province-button:hover {
            background-color: #e5e7eb;
            transform: translateY(-2px);
        }
        .province-button.active {
            background-color: #4f46e5;
            border-color: #6366f1;
            color: white;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
        }

        /* Custom marker icon styling for map */
        .leaflet-div-icon {
            background: none !important;
            border: none !important;
        }
        .location-dot {
            border-radius: 50%;
            background-color: #4f46e5;
            box-shadow: 0 0 8px rgba(79, 70, 229, 0.6);
            transition: all 0.1s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }
        .location-dot-pulse {
            animation: dot-pulse 2s cubic-bezier(0, 0, 0.2, 1) infinite;
            position: absolute;
            border-radius: 50%;
            background-color: #4f46e5;
            opacity: 0.2;
        }
        @keyframes dot-pulse {
            0% { transform: scale(0.5); opacity: 0.8; }
            100% { transform: scale(1.2); opacity: 0; }
        }

        /* Alerts overlay on map */
        .leaflet-control-alerts-overlay { /* Renamed for Leaflet control */
            position: absolute; /* This might be overridden by Leaflet's control positioning */
            bottom: 1rem;
            left: 1rem;
            z-index: 1000;
            max-height: 200px;
            width: 250px;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 0.75rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            color: #1f2937;
        }
        .leaflet-control-alerts-overlay ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .leaflet-control-alerts-overlay li {
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
        }
        .leaflet-control-alerts-overlay::-webkit-scrollbar { width: 4px; }
        .leaflet-control-alerts-overlay::-webkit-scrollbar-track { background: transparent; }
        .leaflet-control-alerts-overlay::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }

        /* Styles for the Monthly/Daily trend chart's filter buttons */
        .chart-filter-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            justify-content: center;
        }
        .chart-filter-button {
            padding: 0.3rem 0.6rem;
            border-radius: 0.3rem;
            background-color: #e0e7ff;
            color: #4f46e5;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid #c7d2fe;
            transition: all 0.2s ease-in-out;
        }
        .chart-filter-button.active {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 2px 5px rgba(79, 70, 229, 0.2);
        }
        .chart-filter-button:hover {
            background-color: #a5b4fc;
        }
        
        /* SVG Map specific styling */
        .leaflet-control-pakistan-svg-overlay {
            z-index: 500;
            position: absolute;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #pakistan-map-svg {
            width: 100%;
            height: 100%;
            display: block;
            margin: auto;
        }
        #pakistan-map-svg path, #pakistan-map-svg circle {
            fill: rgba(167, 243, 208, 0.6);
            stroke: #34d399;
            stroke-width: 0.5;
            transition: fill 0.3s ease, transform 0.1s ease;
            cursor: pointer;
            pointer-events: auto;
        }
        #pakistan-map-svg path:hover, #pakistan-map-svg circle:hover {
            fill: rgba(110, 231, 183, 0.7);
            transform: scale(1.005);
        }
        #pakistan-map-svg path.selected, #pakistan-map-svg circle.selected {
            fill: rgba(5, 150, 105, 0.8);
            stroke: #047857;
            stroke-width: 1.5;
        }
    </style>
</head>
<body>
    <div class="dashboard-grid">
        <header class="card header flex flex-row items-center justify-between !py-2">
            <div class="flex items-center gap-4">
                <img src="https://www.sdpi.org/assets/images/sdpi-logo-2020.webp" alt="SDPI Logo" class="h-10">
            </div>

            <div class="flex items-center justify-center gap-6 flex-grow">
                <h1 class="text-xl font-extrabold text-gray-900 text-gradient-blue-purple">DFLT Phase-2 | Status Deck</h1>
                <div class="flex items-center gap-2">
                    <label for="provinceFilter" class="text-xs font-medium text-gray-600">Province:</label>
                    <select id="provinceFilter" class="block py-1 px-2 border border-gray-300 bg-gray-50 text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-accent-main focus:border-accent-main text-xs" onchange="updateDashboard()">
                        <option value="All">All</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <label for="District_Filter" class="text-xs font-medium text-gray-600">District:</label>
                    <select id="District_Filter" class="block py-1 px-2 border border-gray-300 bg-gray-50 text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-accent-main focus:border-accent-main text-xs" onchange="updateDashboard()">
                        <option value="All">All</option>
                    </select>
                </div>
                <div class="text-right">
                    <p id="currentTime" class="font-bold text-gray-900 text-lg"></p>
                    <p id="currentDate" class="text-xs text-gray-600"></p>
                </div>
            </div>

            <img src="https://resume.brightspyre.com/affiliates/INTERACT%20Consulting/Giz%20pic-6493ec850de4e.png" alt="DFLT Logo" class="h-12">
        </header>

        <div class="card map-card !p-1 relative">
            <div id="map"></div>
            <div class="absolute top-2 right-2 z-[1000] bg-white/70 p-1 rounded-lg border border-gray-200">
                <button id="toggleHeatmap" class="px-3 py-1 text-xs text-white bg-indigo-600 rounded-md">Toggle Heatmap</button>
            </div>
        </div>
        
        <div class="kpi-main">
            <div class="card flex-col items-start">
                <h3 class="text-sm font-medium text-gray-600 flex items-center justify-between w-full">
                    <span>Total Beneficiaries Trained</span>
                    <span id="beneficiariesTargetPct" class="text-xs font-semibold text-teal-500">0%</span>
                </h3>
                <p id="totalBeneficiaries" class="text-4xl font-black text-indigo-600">0</p>
                <div class="flex items-center justify-between w-full mt-2">
                    <span class="text-xs text-gray-500">Target: <span id="beneficiaryOverallTarget">0</span></span>
                    <div class="w-1/2 h-10 ml-auto"><canvas id="beneficiariesMiniChart"></canvas></div>
                </div>
            </div>
            <div class="card flex-col items-start">
                <h3 class="text-sm font-medium text-gray-600 flex items-center justify-between w-full">
                    <span>Total Trainings Conducted</span>
                    <span id="trainingsTargetPct" class="text-xs font-semibold text-emerald-500">0%</span>
                </h3>
                <p id="totalTrainings" class="text-4xl font-black text-indigo-600">0</p>
                <div class="flex items-center justify-between w-full mt-2">
                    <span class="text-xs text-gray-500">Target: <span id="trainingOverallTarget">0</span></span>
                    <div class="w-1/2 h-10 ml-auto"><canvas id="trainingsMiniChart"></canvas></div>
                </div>
            </div>
            <div class="card justify-center col-span-1">
                <h3 class="text-sm font-medium text-gray-600">Top Performing Province</h3>
                <p id="topProvinceName" class="text-2xl font-black text-blue-600 mt-1">N/A</p>
                <p id="topProvincePct" class="text-xl font-bold text-blue-500 mt-0">0% Target Achieved</p>
            </div>
        </div>

        <div class="card provincial-summary-card">
            <div class="flex items-center justify-between flex-shrink-0 mb-4">
                <h3 id="provincialSummaryTitle" class="text-md font-bold text-gray-800">Provincial Performance Overview</h3>
                <div class="flex items-center gap-2">
                    <label for="provincialCardFilter" class="text-xs font-medium text-gray-600">Filter:</label>
                    <select id="provincialCardFilter" class="block py-1 px-2 border border-gray-300 bg-gray-50 text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs"></select>
                </div>
            </div>
            <div id="provincialSummaryContent" class="flex-grow flex flex-col p-4">
                <p class="text-gray-500 text-sm text-center">Select a province to view its performance details.</p>
            </div>
        </div>

        <div class="card monthly-trend-card">
            <h3 class="text-md font-bold text-gray-800 flex-shrink-0">Beneficiaries Trend</h3>
            <div class="chart-filter-buttons">
                <button class="chart-filter-button active" data-unit="month" data-metric="Beneficiary_Count_Actual">Monthly Beneficiaries</button>
                <button class="chart-filter-button" data-unit="day" data-metric="Beneficiary_Count_Actual">Daily Beneficiaries</button>
            </div>
            <div class="chart-container"><canvas id="monthlyTrendChart"></canvas></div>
        </div>

        <div class="card provincial-ranking-card">
            <h3 class="text-md font-bold text-gray-800 flex-shrink-0">Provincial Ranking</h3>
            <div class="flex gap-2 mb-2">
                <button class="chart-filter-button active" data-sort-metric="beneficiaries">By Beneficiaries</button>
                <button class="chart-filter-button" data-sort-metric="trainings">By Trainings</button>
                <button class="chart-filter-button" data-sort-metric="target_achievement">By Target %</button>
                <button class="chart-filter-button" data-sort-metric="district">By District</button>
            </div>
            <div class="table-container mt-2">
                <table id="rankingTable" class="w-full text-left text-sm">
                    <thead class="text-xs text-gray-600 uppercase bg-gray-100">
                        <tr>
                            <th class="px-4 py-2">Rank</th>
                            <th class="px-4 py-2">Province</th>
                            <th class="px-4 py-2">Beneficiaries</th>
                            <th class="px-4 py-2">Trainings</th>
                            <th class="px-4 py-2">Target %</th>
                        </tr>
                    </thead>
                    <tbody id="provincialRankingTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="card leaderboard-card">
            <h3 class="text-md font-bold text-gray-800 flex-shrink-0">Top Trainers (Monthly Ranking)</h3>
            <div class="table-container mt-2">
                <table class="w-full text-left text-sm">
                    <thead class="text-xs text-gray-600 uppercase bg-gray-100">
                        <tr>
                            <th class="px-4 py-2">Rank</th>
                            <th class="px-4 py-2">Trainer</th>
                            <th class="px-4 py-2">Beneficiaries</th>
                            <th class="px-4 py-2">Target %</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global data and state variables
        let trainingData = [];
        let dashboardMetadata = {};
        let provinceDataSummary = {};
        let aggregatedMonthlyTrendData = {};
        let aggregatedDailyTrendData = {};
        let provincialRankingsData = [];
        let leaderboardData = [];
        let districtDataSummary = {};

        // Mini chart instances
        let beneficiariesMiniChart, trainingsMiniChart;
        let occupationsPieChart;

        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTakZtvQeYjOMxvYbL91Ar8L99Ej3t2hZw2xJjFSqg0HLbaWrVyI7-bc4sS9A4RO4pgCH365J2OcRLt/pub?gid=317105383&single=true&output=csv';
        const TOTAL_PROJECT_TARGET_BENEFICIARIES = 250000;
        const MONTHLY_TARGET_PER_TRAINER = 256;

        // Define provincial targets for calculations
        let globalTargets = {
            provinces: {
                "Punjab": {target_beneficiaries: 90000, target_trainings: 600},
                "Sindh": {target_beneficiaries: 60000, target_trainings: 400},
                "Khyber Pakhtunkhwa": {target_beneficiaries: 35000, target_trainings: 250},
                "Balochistan": {target_beneficiaries: 20000, target_trainings: 150},
                "Gilgit-Baltistan": {target_beneficiaries: 10000, target_trainings: 80},
                "Azad Jammu & Kashmir": {target_beneficiaries: 15000, target_trainings: 100},
                "Islamabad Capital Territory": {target_beneficiaries: 5000, target_trainings: 40}
            }
        };

        // Chart color palette and Leaflet map variables
        const CHART_COLORS = {
            primary: '#4f46e5', danger: '#ef4444'
        };
        const provinceColors = {
            "Punjab": "#22c55e", "Sindh": "#3b82f6", "Khyber Pakhtunkhwa": "#f97316", "Balochistan": "#ef4444",
            "Gilgit-Baltistan": "#a855f7", "Azad Jammu & Kashmir": "#06b6d4", "Islamabad Capital Territory": "#facc15"
        };
        let map, markers, heatLayer, monthlyTrendChart;

        /**
         * Fetches data from the Google Sheet CSV and initializes the dashboard.
         * This is the main entry point for the application.
         */
        async function loadDataAndInitialize() {
            try {
                const response = await fetch(GOOGLE_SHEET_CSV_URL);
                if (!response.ok) {
                    throw new Error('Failed to fetch data from Google Sheets. Please ensure the link is correct and the sheet is published to the web.');
                }
                const rawCsv = await response.text();
                
                // Process the raw CSV data into our dashboard's structured format
                const processedData = processCSVData(rawCsv);
                trainingData = processedData.dashboard_data;
                dashboardMetadata = processedData.metadata;
                
                if (!trainingData || trainingData.length === 0) {
                    throw new Error("Dashboard data is missing or empty after processing.");
                }
                
                // Pre-process all data for fast dashboard rendering
                preProcessAllData(trainingData);

                // Populate all dropdown filters and update the UI
                populateFilters(trainingData);
                initializeMap();
                initializeCharts();
                updateDashboard();

                // Set event listeners for interactive elements
                setupEventListeners();
                
            } catch (error) {
                console.error(error);
                // Display a user-friendly error message
                alert("An error occurred while loading dashboard data. Please check the console for details.");
            }
        }
        
        /**
         * Parses the raw CSV string and processes it into the structured JSON format
         * that the dashboard expects. This replaces the Python script.
         * @param {string} csvText - The raw CSV content from the Google Sheet.
         * @returns {object} - An object containing the processed data and metadata.
         */
        function processCSVData(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const dataRows = lines.slice(1).map(line => {
                const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, ''));
                const row = {};
                headers.forEach((header, i) => {
                    row[header] = values[i] || '';
                });
                return row;
            });

            // Separate Day 1 and Day 2 data
            const day1Data = dataRows.filter(row => row.main_menu === 'day1');
            const day2Data = dataRows.filter(row => row.main_menu === 'day2');

            // Map Day 2 attendance CNICs for quick lookup
            const day2Attendance = new Map();
            day2Data.forEach(row => {
                const sessionId = row.day2_session_select;
                if (sessionId) {
                    const cnicList = new Set(row.beneficiaries_present.split(' ').filter(c => c.trim() !== ''));
                    day2Attendance.set(sessionId, cnicList);
                }
            });

            const dashboardRecords = [];
            const sessionsMap = new Map();
            
            day1Data.forEach(row => {
                const sessionId = row.session_id;
                if (!sessionId) return;
                
                if (!sessionsMap.has(sessionId)) {
                    sessionsMap.set(sessionId, {
                        ...row,
                        beneficiaries: [],
                        female_occupations: {}
                    });
                }
                
                for (let i = 1; i <= 36; i++) {
                    const cnicCol = `beneficiary_cnic_${i}`;
                    const nameCol = `beneficiary_name_${i}`;
                    const occupationCol = `occupation_${i}`;

                    const cnic = row[cnicCol];
                    const name = row[nameCol];
                    const occupation = row[occupationCol];

                    if (cnic) {
                        const standardizedCnic = cnic.replace(/[^0-9]/g, '');
                        const hasAttendedDay2 = day2Attendance.get(sessionId)?.has(standardizedCnic) || false;
                        
                        sessionsMap.get(sessionId).beneficiaries.push({
                            cnic: standardizedCnic,
                            name: name,
                            occupation: occupation,
                            attended_day2: hasAttendedDay2
                        });
                        
                        // Aggregate female occupations directly as all are female
                        if (occupation) {
                             sessionsMap.get(sessionId).female_occupations[occupation] = (sessionsMap.get(sessionId).female_occupations[occupation] || 0) + 1;
                        }
                    }
                }
            });

            sessionsMap.forEach(session => {
                const beneficiaryCount = session.beneficiaries.length;
                
                // Calculate retention rate
                const attendedDay2Count = session.beneficiaries.filter(b => b.attended_day2).length;
                const retentionRate = beneficiaryCount > 0 ? (attendedDay2Count / beneficiaryCount) * 100 : 0;
                
                // Calculate average training time
                let avgTrainingTimeHours = 0;
                try {
                    const startTime = new Date(`1970-01-01T${session.start.match(/\d{2}:\d{2}:\d{2}/)[0]}`);
                    const endTime = new Date(`1970-01-01T${session.end.match(/\d{2}:\d{2}:\d{2}/)[0]}`);
                    const durationMs = endTime - startTime;
                    avgTrainingTimeHours = durationMs / (1000 * 60 * 60);
                } catch (e) {}

                // Calculate quality index
                const qualityScore = parseFloat(session.q_read_write || 0) + parseFloat(session.q_recognize_currency || 0) + parseFloat(session.q_simple_math || 0);
                const qualityIndex = qualityScore / 3;

                // Extract location
                let lat = null, lon = null;
                const locationMatch = session.training_location.match(/(\-?\d+\.\d+)\s(\-?\d+\.\d+)/);
                if (locationMatch) {
                    lat = parseFloat(locationMatch[1]);
                    lon = parseFloat(locationMatch[2]);
                }
                
                dashboardRecords.push({
                    TrainingID: session.session_id,
                    Training_Date: session.SubmissionDate,
                    Province: session.province_select,
                    District: session.district_select,
                    ASPC_Name: session.lead_trainer_name,
                    Beneficiary_Count_Actual: beneficiaryCount,
                    Female_Beneficiaries: beneficiaryCount, // All are female
                    Retention_Rate_Pct: parseFloat(retentionRate.toFixed(2)),
                    Avg_Training_Time_Hours: parseFloat(avgTrainingTimeHours.toFixed(1)),
                    Female_Occupations: session.female_occupations,
                    Quality_Index: parseFloat(qualityIndex.toFixed(2)),
                    Start_Location_Lat: lat,
                    Start_Location_Lon: lon,
                });
            });

            return {
                dashboard_data: dashboardRecords,
                metadata: {
                    TOTAL_PROJECT_TARGET_BENEFICIARIES: TOTAL_PROJECT_TARGET_BENEFICIARIES,
                    MONTHLY_TARGET_PER_TRAINER: MONTHLY_TARGET_PER_TRAINER
                }
            };
        }

        /**
         * Pre-processes raw training data into aggregated summaries for faster access.
         * This runs only once on page load.
         */
        function preProcessAllData(data) {
            provinceDataSummary = {};
            districtDataSummary = {};
            aggregatedMonthlyTrendData = {};
            aggregatedDailyTrendData = {};

            data.forEach(item => {
                // Aggregate data at the provincial level
                const provinceName = item.Province;
                if (!provinceDataSummary[provinceName]) {
                    provinceDataSummary[provinceName] = {
                        trainings: 0, beneficiaries: 0, total_training_time: 0, total_retention_rate: 0, total_quality_index: 0, item_count: 0, female_occupations: {}
                    };
                }
                provinceDataSummary[provinceName].trainings++;
                provinceDataSummary[provinceName].beneficiaries += item.Beneficiary_Count_Actual || 0;
                provinceDataSummary[provinceName].total_training_time += item.Avg_Training_Time_Hours || 0;
                provinceDataSummary[provinceName].total_retention_rate += item.Retention_Rate_Pct || 0;
                provinceDataSummary[provinceName].total_quality_index += item.Quality_Index || 0;
                provinceDataSummary[provinceName].item_count++;
                
                for (const occupation in item.Female_Occupations) {
                    provinceDataSummary[provinceName].female_occupations[occupation] = (provinceDataSummary[provinceName].female_occupations[occupation] || 0) + item.Female_Occupations[occupation];
                }

                // Aggregate data at the district level
                const districtName = item.District;
                if (!districtDataSummary[districtName]) {
                    districtDataSummary[districtName] = { trainings: 0, beneficiaries: 0 };
                }
                districtDataSummary[districtName].trainings++;
                districtDataSummary[districtName].beneficiaries += item.Beneficiary_Count_Actual || 0;

                // Aggregate data for monthly/daily trends
                const date = new Date(item.Training_Date);
                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-01`;
                const dayKey = date.toISOString().split('T')[0];
                
                aggregatedMonthlyTrendData[monthKey] = (aggregatedMonthlyTrendData[monthKey] || 0) + (item.Beneficiary_Count_Actual || 0);
                aggregatedDailyTrendData[dayKey] = (aggregatedDailyTrendData[dayKey] || 0) + (item.Beneficiary_Count_Actual || 0);
            });

            // Calculate averages for provinces
            for (const pName in provinceDataSummary) {
                const summary = provinceDataSummary[pName];
                summary.avg_retention_rate = summary.item_count > 0 ? (summary.total_retention_rate / summary.item_count) : 0;
                summary.avg_quality_index = summary.item_count > 0 ? (summary.total_quality_index / summary.item_count) : 0;
                summary.avg_training_time = summary.item_count > 0 ? (summary.total_training_time / summary.item_count) : 0;
            }

            // Create data for provincial rankings table
            const provincialPerformance = {};
            for (const pName in globalTargets.provinces) {
                provincialPerformance[pName] = {
                    beneficiaries: 0, trainings: 0,
                    target_beneficiaries: globalTargets.provinces[pName].target_beneficiaries,
                    target_trainings: globalTargets.provinces[pName].target_trainings
                };
            }
            data.forEach(item => {
                const provinceName = item.Province;
                if (provincialPerformance[provinceName]) {
                    provincialPerformance[provinceName].beneficiaries += (item.Beneficiary_Count_Actual || 0);
                    provincialPerformance[provinceName].trainings++;
                }
            });
            provincialRankingsData = Object.entries(provincialPerformance).map(([provinceName, stats]) => {
                const beneficiaryTargetPct = stats.target_beneficiaries > 0 ? (stats.beneficiaries / stats.target_beneficiaries) * 100 : 0;
                return {
                    province: provinceName, beneficiaries: stats.beneficiaries, trainings: stats.trainings,
                    beneficiary_target_pct: beneficiaryTargetPct, training_target_pct: stats.target_trainings
                };
            });

            // Create data for top trainers leaderboard
            const now = new Date();
            const monthlyData = data.filter(item => {
                const trainingDate = new Date(item.Training_Date);
                return trainingDate.getMonth() === now.getMonth() && trainingDate.getFullYear() === now.getFullYear();
            });
            const trainerPerformance = monthlyData.reduce((acc, item) => {
                const trainerName = item.ASPC_Name;
                if (trainerName) {
                    if (!acc[trainerName]) acc[trainerName] = { beneficiaries: 0, trainings: 0 };
                    acc[trainerName].beneficiaries += (item.Beneficiary_Count_Actual || 0);
                    acc[trainerName].trainings++;
                }
                return acc;
            }, {});
            leaderboardData = Object.entries(trainerPerformance).map(([name, stats]) => {
                const percent = Math.min(100, Math.round((stats.beneficiaries / MONTHLY_TARGET_PER_TRAINER) * 100));
                return { name, beneficiaries: stats.beneficiaries, target_pct: percent };
            }).sort((a, b) => b.beneficiaries - a.beneficiaries).slice(0, 5);
        }

        /**
         * Sets up all the event listeners for the dashboard controls.
         */
        function setupEventListeners() {
            // Update the provincial ranking table based on the selected metric
            document.querySelectorAll('.provincial-ranking-card .chart-filter-button').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.provincial-ranking-card .chart-filter-button').forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    updateProvincialRanking();
                });
            });

            // Update the monthly trend chart based on the selected time unit
            document.querySelectorAll('.monthly-trend-card .chart-filter-buttons .chart-filter-button').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.monthly-trend-card .chart-filter-buttons .chart-filter-button').forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    const filteredData = trainingData.filter(item => document.getElementById('provinceFilter').value === 'All' || item.Province === document.getElementById('provinceFilter').value);
                    updateMonthlyTrendChart(filteredData, button.dataset.unit, button.dataset.metric);
                });
            });

            // Handle map click events to select a province
            document.getElementById('map').addEventListener('click', (event) => {
                let targetElement = event.target;
                while (targetElement && targetElement !== this && !targetElement.dataset.provinceName) {
                    targetElement = targetElement.parentNode;
                }
                if (targetElement && targetElement.dataset.provinceName) {
                    const provinceName = targetElement.dataset.provinceName;
                    document.getElementById('provinceFilter').value = provinceName;
                    updateDashboard();
                } else {
                    document.getElementById('provinceFilter').value = 'All';
                    updateDashboard();
                }
            });
            document.getElementById('toggleHeatmap').addEventListener('click', toggleHeatmap);
        }
        
        /**
         * Updates the current time and date in the header.
         */
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        }

        /**
         * Populates the province and district dropdown filters.
         */
        function populateFilters(data) {
            const provinceFilter = document.getElementById('provinceFilter');
            const districtFilter = document.getElementById('District_Filter');
            const provincialCardFilter = document.getElementById('provincialCardFilter');

            const uniqueProvinces = [...new Set(data.map(item => item.Province).filter(Boolean))].sort();
            const uniqueDistricts = [...new Set(data.map(item => item.District).filter(Boolean))].sort();

            // Populate Province filters
            provinceFilter.innerHTML = '<option value="All">All Provinces</option>';
            provincialCardFilter.innerHTML = '<option value="Select Province">Select Province</option><option value="All">All Provinces</option>';
            uniqueProvinces.forEach(p => {
                provinceFilter.add(new Option(p, p));
                provincialCardFilter.add(new Option(p, p));
            });

            // Populate District filter
            districtFilter.innerHTML = '<option value="All">All Districts</option>';
            uniqueDistricts.forEach(d => {
                districtFilter.add(new Option(d, d));
            });

            // Set the default filter to Punjab
            provinceFilter.value = 'Punjab';
            provincialCardFilter.value = 'Punjab';
        }

        /**
         * Initializes the Leaflet map and heat map layers.
         */
        function initializeMap() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([30.3753, 69.3451], 5.5);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a>'
            }).addTo(map);

            markers = L.featureGroup().addTo(map);
            heatLayer = L.heatLayer([], {
                radius: 25, blur: 15, maxZoom: 10,
                gradient: { 0.4: '#60a5fa', 0.65: '#2dd4bf', 1: '#ef4444' }
            });
        }

        /**
         * Toggles the visibility of the heat map layer.
         */
        function toggleHeatmap() {
            if (map.hasLayer(heatLayer)) {
                map.removeLayer(heatLayer);
                map.addLayer(markers);
            } else {
                map.removeLayer(markers);
                map.addLayer(heatLayer);
            }
        }

        /**
         * Updates all dashboard components based on the current filters.
         */
        function updateDashboard() {
            const provinceFilterValue = document.getElementById('provinceFilter').value;
            const districtFilterValue = document.getElementById('District_Filter').value;
            
            let filteredData = trainingData.filter(item => {
                const provinceMatch = provinceFilterValue === 'All' || item.Province === provinceFilterValue;
                const districtMatch = districtFilterValue === 'All' || item.District === districtFilterValue;
                return provinceMatch && districtMatch;
            });

            updateKPIs(filteredData, provinceFilterValue);
            updateMapAndHeatmap(filteredData);
            updateLeaderboard();
            updateProvincialRanking();

            const activeUnitButton = document.querySelector('.monthly-trend-card .chart-filter-buttons .active');
            const currentUnit = activeUnitButton ? activeUnitButton.dataset.unit : 'month';
            const currentMetric = activeUnitButton ? activeUnitButton.dataset.metric : 'Beneficiary_Count_Actual';
            updateMonthlyTrendChart(filteredData, currentUnit, currentMetric);

            // Update the provincial summary card based on the current province filter
            document.getElementById('provincialCardFilter').value = provinceFilterValue;
            updateProvincialSummaryContent(provinceFilterValue);
            
            // Highlight the selected province on the SVG map
            document.querySelectorAll('#pakistan-map-svg path, #pakistan-map-svg circle').forEach(path => path.classList.remove('selected'));
            if (provinceFilterValue !== 'All') {
                const svgProvinceElement = document.querySelector(`#pakistan-map-svg [data-province-name="${provinceFilterValue}"]`);
                if (svgProvinceElement) {
                    svgProvinceElement.classList.add('selected');
                }
            }
        }

        /**
         * Animates a numerical value from its current state to a new state.
         */
        function animateValue(obj, start, end, duration, isPercent = false) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const value = Math.floor(start + progress * (end - start));
                obj.innerHTML = value.toLocaleString() + (isPercent ? '%' : '');
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        /**
         * Updates the main KPI cards at the top of the dashboard.
         */
        function updateKPIs(data, currentFilterProvince) {
            const totalBeneficiaries = data.reduce((s, i) => s + (i.Beneficiary_Count_Actual || 0), 0);
            const totalTrainings = data.length;

            let overallBeneficiaryTarget = 0;
            let overallTrainingTarget = 0;

            if (currentFilterProvince === 'All') {
                overallBeneficiaryTarget = TOTAL_PROJECT_TARGET_BENEFICIARIES;
                overallTrainingTarget = Object.values(globalTargets.provinces).reduce((sum, p) => sum + p.target_trainings, 0);
            } else {
                const provinceData = globalTargets.provinces[currentFilterProvince];
                overallBeneficiaryTarget = provinceData ? provinceData.target_beneficiaries : 0;
                overallTrainingTarget = provinceData ? provinceData.target_trainings : 0;
            }
            
            const beneficiariesTargetPct = overallBeneficiaryTarget > 0 ? ((totalBeneficiaries / overallBeneficiaryTarget) * 100).toFixed(1) : '0';
            const trainingsTargetPct = overallTrainingTarget > 0 ? ((totalTrainings / overallTrainingTarget) * 100).toFixed(1) : '0';

            animateValue(document.getElementById('totalBeneficiaries'), parseInt(document.getElementById('totalBeneficiaries').textContent.replace(/,/g, '') || '0'), totalBeneficiaries, 1000);
            document.getElementById('beneficiariesTargetPct').textContent = `${beneficiariesTargetPct}% Target`;
            document.getElementById('beneficiaryOverallTarget').textContent = overallBeneficiaryTarget.toLocaleString();

            animateValue(document.getElementById('totalTrainings'), parseInt(document.getElementById('totalTrainings').textContent.replace(/,/g, '') || '0'), totalTrainings, 1000);
            document.getElementById('trainingsTargetPct').textContent = `${trainingsTargetPct}% Target`;
            document.getElementById('trainingOverallTarget').textContent = overallTrainingTarget.toLocaleString();

            let topProvince = null;
            let maxProvinceAchievedPct = -1;

            for (const pName in globalTargets.provinces) {
                const summarizedProvince = provinceDataSummary[pName];
                if (summarizedProvince) {
                    const currentBeneficiaries = summarizedProvince.beneficiaries;
                    const provinceTarget = globalTargets.provinces[pName].target_beneficiaries;
                    const achievedPct = provinceTarget > 0 ? (currentBeneficiaries / provinceTarget) * 100 : 0;
                    if (achievedPct > maxProvinceAchievedPct) {
                        maxProvinceAchievedPct = achievedPct;
                        topProvince = pName;
                    }
                }
            }
            document.getElementById('topProvinceName').textContent = topProvince || 'N/A';
            document.getElementById('topProvincePct').textContent = `${maxProvinceAchievedPct.toFixed(1)}% Target Achieved`;

            // Update mini trend charts
            updateMiniTrendCharts(data);
        }

        /**
         * Updates the mini trend charts in the KPI cards.
         * @param {Array<Object>} data - The filtered training data.
         */
        function updateMiniTrendCharts(data) {
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const filteredData = data.filter(item => new Date(item.Training_Date) >= thirtyDaysAgo);

            const dailyBeneficiaries = {};
            const dailyTrainings = {};
            
            filteredData.forEach(item => {
                const dateKey = item.Training_Date;
                dailyBeneficiaries[dateKey] = (dailyBeneficiaries[dateKey] || 0) + (item.Beneficiary_Count_Actual || 0);
                dailyTrainings[dateKey] = (dailyTrainings[dateKey] || 0) + 1;
            });

            const labels = Object.keys(dailyBeneficiaries).sort();
            const beneficiaryData = labels.map(key => dailyBeneficiaries[key]);
            const trainingData = labels.map(key => dailyTrainings[key]);

            if (beneficiariesMiniChart) {
                beneficiariesMiniChart.data.labels = labels;
                beneficiariesMiniChart.data.datasets[0].data = beneficiaryData;
                beneficiariesMiniChart.update();
            }

            if (trainingsMiniChart) {
                trainingsMiniChart.data.labels = labels;
                trainingsMiniChart.data.datasets[0].data = trainingData;
                trainingsMiniChart.update();
            }
        }

        /**
         * Updates the markers and heatmap on the map.
         */
        function updateMapAndHeatmap(data) {
            markers.clearLayers();
            const heatPoints = [];
            const maxBeneficiaryCount = Math.max(...data.map(item => item.Beneficiary_Count_Actual || 0), 1);
            data.forEach(item => {
                const lat = parseFloat(item.Start_Location_Lat);
                const lon = parseFloat(item.Start_Location_Lon);
                if (!isNaN(lat) && !isNaN(lon)) {
                    const latLng = [lat, lon];
                    heatPoints.push([...latLng, (item.Beneficiary_Count_Actual || 0) / maxBeneficiaryCount]);
                    const markerSize = 14 + ((item.Beneficiary_Count_Actual || 0) / maxBeneficiaryCount) * 20;
                    const markerIcon = L.divIcon({
                        html: `<div style="position: relative; display: flex; align-items: center; justify-content: center;"><div class="location-dot-pulse" style="width:${markerSize*1.5}px; height:${markerSize*1.5}px; background-color:${provinceColors[item.Province] || '#4f46e5'}1A;"></div><div class="location-dot" style="width:${markerSize}px; height:${markerSize}px; background-color:${provinceColors[item.Province] || '#4f46e5'};"><svg viewBox="0 0 24 24" fill="white" width="${markerSize*0.6}" height="${markerSize*0.6}"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z"/></svg></div></div>`,
                        className: 'leaflet-div-icon',
                        iconSize: [markerSize * 1.5, markerSize * 1.5],
                        iconAnchor: [markerSize * 0.75, markerSize * 0.75]
                    });
                    L.marker(latLng, { icon: markerIcon }).bindPopup(`
                        <div style="font-family: 'Montserrat', sans-serif; color: #1f2937;">
                            <div class="font-bold text-base mb-1">${item.ASPC_Name || 'N/A'}</div>
                            <div class="text-xs text-gray-600 mb-2">Training ID: ${item.TrainingID || 'N/A'}</div>
                            <div class="text-sm text-gray-700"><strong>Beneficiaries:</strong> <span class="text-indigo-600 font-bold">${item.Beneficiary_Count_Actual || 0}</span></div>
                            <div class="text-sm text-gray-700"><strong>Training Date:</strong> ${item.Training_Date || 'N/A'}</div>
                            <div class="text-xs text-gray-500 mt-2">in ${item.District || 'N/A'}, ${item.Province || 'N/A'}</div>
                        </div>`, { maxWidth: 250 }).addTo(markers);
                }
            });
            heatLayer.setLatLngs(heatPoints);
            if (markers.getLayers().length > 0) {
                map.fitBounds(markers.getBounds().pad(0.1));
            } else {
                map.setView([30.3753, 69.3451], 5.5);
            }
        }
        
        /**
         * Updates the provincial summary content with detailed metrics.
         */
        function updateProvincialSummaryContent(selectedProvinceName) {
            const provincialSummaryContent = document.getElementById('provincialSummaryContent');
            const provincialSummaryTitle = document.getElementById('provincialSummaryTitle');
            const provinceData = provinceDataSummary[selectedProvinceName];
            
            provincialSummaryTitle.textContent = `Provincial Performance Overview for ${selectedProvinceName}`;
            
            if (!provinceData || selectedProvinceName === 'All' || selectedProvinceName === 'Select Province') {
                provincialSummaryContent.innerHTML = `<p class="text-gray-500 text-sm text-center">Select a province to view its performance details.</p>`;
                return;
            }

            // Create occupations data for the pie chart
            const occupationLabels = Object.keys(provinceData.female_occupations);
            const occupationData = Object.values(provinceData.female_occupations);
            const totalOccupations = occupationData.reduce((sum, val) => sum + val, 0);

            // Dynamically generate a visually appealing color palette for the pie chart
            const dynamicColors = occupationLabels.map((_, i) => `hsl(${i * 60}, 70%, 50%)`);

            provincialSummaryContent.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-100 p-4 rounded-lg shadow-sm">
                        <h4 class="text-sm font-medium text-gray-600">Total Beneficiaries</h4>
                        <p class="text-2xl font-bold text-indigo-600">${(provinceData.beneficiaries || 0).toLocaleString()}</p>
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg shadow-sm">
                        <h4 class="text-sm font-medium text-gray-600">Total Trainings</h4>
                        <p class="text-2xl font-bold text-teal-600">${(provinceData.trainings || 0).toLocaleString()}</p>
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg shadow-sm">
                        <h4 class="text-sm font-medium text-gray-600">Avg. Retention Rate</h4>
                        <p class="text-2xl font-bold text-yellow-600">${(provinceData.avg_retention_rate || 0).toFixed(1)}%</p>
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg shadow-sm">
                        <h4 class="text-sm font-medium text-gray-600">Avg. Quality Index</h4>
                        <p class="text-2xl font-bold text-blue-600">${(provinceData.avg_quality_index || 0).toFixed(2)}</p>
                    </div>
                </div>

                <div class="mt-6 p-4 bg-white rounded-lg shadow-sm flex-grow">
                    <h4 class="text-lg font-bold text-gray-800 mb-2">Top Occupations</h4>
                    <div class="chart-container h-full w-full flex items-center justify-center">
                        ${totalOccupations > 0 ? '<canvas id="occupationsPieChart"></canvas>' : '<p class="text-gray-500 text-sm text-center">No occupation data available.</p>'}
                    </div>
                </div>
            `;
            if (totalOccupations > 0) {
                renderOccupationsPieChart(occupationLabels, occupationData, dynamicColors);
            }
        }

        /**
         * Renders the pie chart for occupations.
         */
        function renderOccupationsPieChart(labels, data, colors) {
            const ctx = document.getElementById('occupationsPieChart').getContext('2d');
            if (occupationsPieChart) {
                occupationsPieChart.destroy();
            }
            occupationsPieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    family: 'Montserrat'
                                }
                            }
                        },
                        tooltip: {
                            titleFont: { family: 'Montserrat' },
                            bodyFont: { family: 'Montserrat' },
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }


        /**
         * Initializes the Chart.js instances.
         */
        function initializeCharts() {
            const ticksColor = '#212529', gridColor = '#e5e7eb';
            const defaultOptions = {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        titleFont: { family: 'Montserrat' },
                        bodyFont: { family: 'Montserrat' }
                    },
                    annotation: {
                        annotations: {
                            targetLine: {
                                type: 'line', yScaleID: 'y', value: 0, borderColor: '#ef4444',
                                borderWidth: 2, borderDash: [6, 6],
                                label: {
                                    content: 'Target', enabled: true, position: 'end',
                                    color: '#ef4444', font: { family: 'Montserrat', size: 10 }
                                }
                            }
                        }
                    }
                },
                scales: {
                    x: { ticks: { color: ticksColor, font: { family: 'Montserrat' } }, grid: { color: gridColor } },
                    y: { beginAtZero: true, ticks: { color: ticksColor, font: { family: 'Montserrat' } }, grid: { color: gridColor } }
                }
            };
            
            const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
            monthlyTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        borderWidth: 2,
                        tension: 0.4, // Increased tension for a smoother line
                        pointRadius: 3,
                        pointBackgroundColor: '#4f46e5',
                        borderColor: '#4f46e5',
                        fill: true,
                        backgroundColor: (context) => {
                            const chart = context.chart;
                            const {ctx, chartArea} = chart;
                            if (!chartArea) {
                                return null;
                            }
                            const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                            gradient.addColorStop(0, 'rgba(79, 70, 229, 0)');
                            gradient.addColorStop(1, 'rgba(79, 70, 229, 0.4)');
                            return gradient;
                        }
                    }]
                },
                options: {
                    ...defaultOptions,
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'month' },
                            ticks: { color: ticksColor, font: { family: 'Montserrat' } },
                            grid: { color: gridColor }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { color: ticksColor, font: { family: 'Montserrat' } },
                            grid: { color: gridColor }
                        }
                    }
                }
            });

            // Mini chart options
            const miniChartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                elements: { point: { radius: 0 } },
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                scales: {
                    x: { display: false },
                    y: { display: false }
                },
                layout: {
                    padding: { top: 0, bottom: 0, left: 0, right: 0 }
                }
            };

            // Initialize Beneficiaries Mini Chart
            const beneficiariesCtx = document.getElementById('beneficiariesMiniChart').getContext('2d');
            beneficiariesMiniChart = new Chart(beneficiariesCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        borderColor: '#2dd4bf',
                        borderWidth: 1.5,
                        tension: 0.6,
                        fill: false
                    }]
                },
                options: miniChartOptions
            });

            // Initialize Trainings Mini Chart
            const trainingsCtx = document.getElementById('trainingsMiniChart').getContext('2d');
            trainingsMiniChart = new Chart(trainingsCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        borderColor: '#34d399',
                        borderWidth: 1.5,
                        tension: 0.6,
                        fill: false
                    }]
                },
                options: miniChartOptions
            });
        }

        /**
         * Updates the monthly/daily trend chart data.
         */
        function updateMonthlyTrendChart(filteredData, unit = 'month', metric = 'Beneficiary_Count_Actual') {
            let dataToUse;
            if (unit === 'day') {
                dataToUse = aggregatedDailyTrendData;
            } else {
                dataToUse = aggregatedMonthlyTrendData;
            }

            let filteredAggregatedData = {};
            
            // Re-aggregate based on current filter selection
            filteredData.forEach(item => {
                const date = new Date(item.Training_Date);
                const key = (unit === 'day') ? date.toISOString().split('T')[0] : `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-01`;
                filteredAggregatedData[key] = (filteredAggregatedData[key] || 0) + (item[metric] || 0);
            });

            const sortedKeys = Object.keys(filteredAggregatedData).sort();
            const labels = sortedKeys.map(key => new Date(key));
            const values = sortedKeys.map(key => filteredAggregatedData[key]);
            
            // Update the chart data and options
            monthlyTrendChart.data.labels = labels;
            monthlyTrendChart.data.datasets[0].data = values;
            monthlyTrendChart.options.scales.x.time.unit = unit;
            
            // Set the target line value
            let currentTargetValue = (unit === 'day') ? (TOTAL_PROJECT_TARGET_BENEFICIARIES / 8) / 30.4 : (TOTAL_PROJECT_TARGET_BENEFICIARIES / 8);
            monthlyTrendChart.options.plugins.annotation.annotations.targetLine.value = currentTargetValue;
            monthlyTrendChart.options.plugins.annotation.annotations.targetLine.label.content = `Target: ${currentTargetValue.toFixed(0)}`;
            
            monthlyTrendChart.update();
        }

        /**
         * Updates the provincial ranking table.
         */
        function updateProvincialRanking() {
            const activeSortButton = document.querySelector('.provincial-ranking-card .flex.gap-2 .chart-filter-button.active');
            const sortMetric = activeSortButton ? activeSortButton.dataset.sortMetric : 'beneficiaries';
            const tableBody = document.getElementById('provincialRankingTableBody');
            const rankingTable = document.getElementById('rankingTable');

            let sortedData = [];
            let tableHeaderHTML = '';

            // Logic for each sort/filter button
            if (sortMetric === 'beneficiaries') {
                sortedData = [...provincialRankingsData].sort((a, b) => b.beneficiaries - a.beneficiaries);
                tableHeaderHTML = `
                    <tr>
                        <th class="px-4 py-2">Rank</th>
                        <th class="px-4 py-2">Province</th>
                        <th class="px-4 py-2">Beneficiaries</th>
                        <th class="px-4 py-2">Trainings</th>
                        <th class="px-4 py-2">Target %</th>
                    </tr>
                `;
                tableBody.innerHTML = sortedData.map((item, index) => {
                    const targetPercentColor = item.beneficiary_target_pct >= 100 ? 'bg-green-500' : (item.beneficiary_target_pct >= 75 ? 'bg-yellow-500' : 'bg-red-500');
                    return `
                        <tr class="border-b border-gray-200">
                            <td class="px-4 py-2 font-medium text-gray-800">${index + 1}</td>
                            <td class="px-4 py-2 text-gray-700">${item.province}</td>
                            <td class="px-4 py-2 text-gray-700">${(item.beneficiaries || 0).toLocaleString()}</td>
                            <td class="px-4 py-2 text-gray-700">${(item.trainings || 0).toLocaleString()}</td>
                            <td class="px-4 py-2 text-gray-700">
                                <div class="w-full bg-gray-300 rounded-full h-2.5">
                                    <div class="${targetPercentColor} h-2.5 rounded-full" style="width: ${Math.min(100, item.beneficiary_target_pct)}%"></div>
                                </div>
                                <span class="text-xs text-gray-600">${(item.beneficiary_target_pct || 0).toFixed(1)}%</span>
                            </td>
                        </tr>`;
                }).join('');
            } else if (sortMetric === 'trainings') {
                 sortedData = [...provincialRankingsData].sort((a, b) => b.trainings - a.trainings);
                tableHeaderHTML = `
                    <tr>
                        <th class="px-4 py-2">Rank</th>
                        <th class="px-4 py-2">Province</th>
                        <th class="px-4 py-2">Trainings</th>
                        <th class="px-4 py-2">Beneficiaries</th>
                        <th class="px-4 py-2">Target %</th>
                    </tr>
                `;
                tableBody.innerHTML = sortedData.map((item, index) => {
                     const targetPercentColor = item.beneficiary_target_pct >= 100 ? 'bg-green-500' : (item.beneficiary_target_pct >= 75 ? 'bg-yellow-500' : 'bg-red-500');
                    return `
                        <tr class="border-b border-gray-200">
                            <td class="px-4 py-2 font-medium text-gray-800">${index + 1}</td>
                            <td class="px-4 py-2 text-gray-700">${item.province}</td>
                            <td class="px-4 py-2 text-gray-700">${(item.trainings || 0).toLocaleString()}</td>
                            <td class="px-4 py-2 text-gray-700">${(item.beneficiaries || 0).toLocaleString()}</td>
                            <td class="px-4 py-2 text-gray-700">
                                <div class="w-full bg-gray-300 rounded-full h-2.5">
                                    <div class="${targetPercentColor} h-2.5 rounded-full" style="width: ${Math.min(100, item.beneficiary_target_pct)}%"></div>
                                </div>
                                <span class="text-xs text-gray-600">${(item.beneficiary_target_pct || 0).toFixed(1)}%</span>
                            </td>
                        </tr>`;
                }).join('');
            } else if (sortMetric === 'target_achievement') {
                sortedData = [...provincialRankingsData].sort((a, b) => b.beneficiary_target_pct - a.beneficiary_target_pct);
                tableHeaderHTML = `
                    <tr>
                        <th class="px-4 py-2">Rank</th>
                        <th class="px-4 py-2">Province</th>
                        <th class="px-4 py-2">Target %</th>
                        <th class="px-4 py-2">Beneficiaries</th>
                        <th class="px-4 py-2">Trainings</th>
                    </tr>
                `;
                tableBody.innerHTML = sortedData.map((item, index) => {
                     const targetPercentColor = item.beneficiary_target_pct >= 100 ? 'bg-green-500' : (item.beneficiary_target_pct >= 75 ? 'bg-yellow-500' : 'bg-red-500');
                    return `
                        <tr class="border-b border-gray-200">
                            <td class="px-4 py-2 font-medium text-gray-800">${index + 1}</td>
                            <td class="px-4 py-2 text-gray-700">${item.province}</td>
                            <td class="px-4 py-2 text-gray-700">
                                <div class="w-full bg-gray-300 rounded-full h-2.5">
                                    <div class="${targetPercentColor} h-2.5 rounded-full" style="width: ${Math.min(100, item.beneficiary_target_pct)}%"></div>
                                </div>
                                <span class="text-xs text-gray-600">${(item.beneficiary_target_pct || 0).toFixed(1)}%</span>
                            </td>
                            <td class="px-4 py-2 text-gray-700">${(item.beneficiaries || 0).toLocaleString()}</td>
                            <td class="px-4 py-2 text-gray-700">${(item.trainings || 0).toLocaleString()}</td>
                        </tr>`;
                }).join('');
            } else if (sortMetric === 'district') {
                const sortedDistricts = Object.entries(districtDataSummary).map(([name, stats]) => ({
                    name,
                    trainings: stats.trainings,
                    beneficiaries: stats.beneficiaries
                })).sort((a, b) => b.trainings - a.trainings);
                
                tableHeaderHTML = `
                    <tr>
                        <th class="px-4 py-2">Rank</th>
                        <th class="px-4 py-2">District</th>
                        <th class="px-4 py-2">Trainings</th>
                        <th class="px-4 py-2">Beneficiaries</th>
                    </tr>
                `;
                tableBody.innerHTML = sortedDistricts.map((item, index) => {
                    return `
                        <tr class="border-b border-gray-200">
                            <td class="px-4 py-2 font-medium text-gray-800">${index + 1}</td>
                            <td class="px-4 py-2 text-gray-700">${item.name}</td>
                            <td class="px-4 py-2 text-gray-700">${(item.trainings || 0).toLocaleString()}</td>
                            <td class="px-4 py-2 text-gray-700">${(item.beneficiaries || 0).toLocaleString()}</td>
                        </tr>`;
                }).join('');
            }

            // Update the table header
            rankingTable.querySelector('thead').innerHTML = tableHeaderHTML;

            if ((sortMetric !== 'district' && sortedData.length === 0) || (sortMetric === 'district' && Object.keys(districtDataSummary).length === 0)) {
                const colspan = sortMetric === 'district' ? 4 : 5;
                tableBody.innerHTML = `<tr><td colspan="${colspan}" class="px-4 py-2 text-center text-gray-500">No data available.</td></tr>`;
            }
        }
        
        /**
         * Updates the top trainers leaderboard table.
         */
        function updateLeaderboard() {
            const sortedTrainers = leaderboardData;
            const tableBody = document.getElementById('leaderboardTableBody');
            tableBody.innerHTML = '';
            if (sortedTrainers.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="px-4 py-2 text-center text-gray-500">No trainer data this month.</td></tr>`;
            } else {
                sortedTrainers.forEach((item, index) => {
                    const targetPercentColor = item.target_pct >= 100 ? 'bg-green-500' : (item.target_pct >= 75 ? 'bg-yellow-500' : 'bg-red-500');
                    tableBody.innerHTML += `
                        <tr class="border-b border-gray-200">
                            <td class="px-4 py-2 font-medium text-gray-800">${index + 1}</td>
                            <td class="px-4 py-2 text-gray-700">${item.name}</td>
                            <td class="px-4 py-2 text-gray-700">${(item.beneficiaries || 0).toLocaleString()}</td>
                            <td class="px-4 py-2 text-gray-700">
                                <div class="w-full bg-gray-300 rounded-full h-2.5">
                                    <div class="${targetPercentColor} h-2.5 rounded-full" style="width: ${item.target_pct}%"></div>
                                </div>
                                <span class="text-xs text-gray-600">${item.target_pct}%</span>
                            </td>
                        </tr>`;
                });
            }
        }

        // Initial call to load data and set up the dashboard
        document.addEventListener('DOMContentLoaded', () => {
            updateTime();
            setInterval(updateTime, 1000);
            loadDataAndInitialize();
        });
    </script>
</body>
</html>
