<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DFLT Phase 2 Dashboard</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        /* Custom CSS Variables for easy theme management */
        :root {
            --bg-color: #f0f4f8;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --brand-color: #4f46e5;
            --brand-light: #e0e7ff;
            --gradient-start: #f8fafc;
            --gradient-end: #eef2f5;
        }

        /* Base styles for body and font */
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-color);
            background-image: linear-gradient(175deg, var(--bg-color) 0%, #dbe7f2 100%);
            color: var(--text-primary);
            overflow: auto;
            min-height: 100vh;
        }

        /* Main dashboard grid layout using CSS Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-template-rows: 70px repeat(10, minmax(0, 1fr));
            gap: 1.5rem;
            padding: 1.5rem;
            box-sizing: border-box;
            height: 100vh;
        }

        /* Styling for all dashboard cards with animations and shadows */
        .card {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.5s ease-out forwards;
            color: var(--text-primary);
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            min-height: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card:hover {
            box-shadow: 0 12px 30px rgba(0,0,0,0.12);
            transform: translateY(-5px);
        }

        /* General font styles */
        h1, h2, h3, h4, p, span, div, label, select, button, table, th, td {
            font-family: 'Montserrat', sans-serif !important;
            color: var(--text-primary);
        }
        .text-gray-400 { color: var(--text-secondary) !important; }
        .text-gray-600 { color: #64748b !important; }
        .text-indigo-600 { color: var(--brand-color) !important; }

        /* Keyframe animation for general fade-in effect */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Welcome Overlay & Animations */
        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom right, var(--gradient-start), var(--gradient-end));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 1s ease-in-out;
        }

        .welcome-logo, .welcome-text-1, .welcome-text-2 {
            opacity: 0;
            transform: translateY(20px);
            animation-fill-mode: forwards;
        }

        .welcome-logo {
            animation: fadeInSlideUp 1s ease-out;
            animation-delay: 0.5s;
        }
        .welcome-text-1 {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--brand-color);
            animation: fadeInSlideUp 1.5s ease-out;
            animation-delay: 1.5s;
        }
        .welcome-text-2 {
            font-size: 1.125rem;
            color: var(--text-secondary);
            animation: fadeInSlideUp 1.5s ease-out;
            animation-delay: 2.5s;
        }
        @keyframes fadeInSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Grid placement for main sections */
        .header {
            grid-column: 1 / -1;
            grid-row: 1;
            background-color: var(--card-bg);
            border-radius: 1rem;
            padding: 1rem 2rem;
        }
        .map-card {
            grid-column: 1 / 8;
            grid-row: 2 / 8;
            position: relative;
            padding: 0.75rem;
        }
        .kpi-main {
            grid-column: 8 / 13;
            grid-row: 2 / 4;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            background-color: transparent;
            border: none;
            box-shadow: none;
            padding: 0;
        }
        .kpi-main .card {
            justify-content: center;
        }
        .provincial-summary-card {
            grid-column: 8 / 13;
            grid-row: 4 / 8;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            overflow-y: hidden;
        }
        #provincialSummaryContent {
            flex-grow: 1;
            overflow-y: auto;
        }
        .monthly-trend-card {
            grid-column: 1 / 5;
            grid-row: 8 / 12;
        }
        .provincial-ranking-card {
            grid-column: 5 / 9;
            grid-row: 8 / 12;
        }
        .leaderboard-card {
            grid-column: 9 / 13;
            grid-row: 8 / 12;
        }

        /* Leaflet map styling */
        #map {
            height: 100%;
            width: 100%;
            border-radius: 1.25rem;
            z-index: 0;
        }
        .leaflet-popup-content-wrapper {
            background-color: #fff;
            color: #1f2937;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-family: 'Montserrat', sans-serif !important;
        }
        .leaflet-popup-tip { background-color: #fff; }
        .leaflet-popup-content-wrapper * { font-family: 'Montserrat', sans-serif !important; color: #1f2937; }

        /* Custom marker icon styling for map */
        .leaflet-div-icon {
            background: none !important;
            border: none !important;
        }
        .location-dot {
            border-radius: 50%;
            background-color: var(--brand-color);
            box-shadow: 0 0 12px rgba(79, 70, 229, 0.8);
            transition: all 0.2s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid white;
        }
        .location-dot:hover {
            transform: scale(1.1);
            box-shadow: 0 0 16px rgba(79, 70, 229, 1);
        }
        .location-dot-pulse {
            animation: dot-pulse 2s cubic-bezier(0, 0, 0.2, 1) infinite;
            position: absolute;
            border-radius: 50%;
            background-color: var(--brand-color);
            opacity: 0.3;
        }
        @keyframes dot-pulse {
            0% { transform: scale(0.5); opacity: 0.8; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        /* Chart.js specific styling */
        .chart-container {
            flex-grow: 1;
            position: relative;
            min-height: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
        }

        /* Table container for scrolling content within cards */
        .table-container {
            flex-grow: 1;
            overflow-y: auto;
            min-height: 0;
        }
        .table-container::-webkit-scrollbar { width: 6px; }
        .table-container::-webkit-scrollbar-track { background: transparent; }
        .table-container::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 10px; }
        .table-container thead {
            background-color: #f3f4f6;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        /* Provincial Summary Card Specific Styles */
        .province-metric-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 1rem;
            border-radius: 0.75rem;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
        }

        /* Chart filter button styles */
        .chart-filter-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            justify-content: center;
        }
        .chart-filter-button {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            background-color: #e0e7ff;
            color: var(--brand-color);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--brand-light);
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(67, 56, 202, 0.1);
        }
        .chart-filter-button:hover {
            background-color: #c7d2fe;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(67, 56, 202, 0.2);
        }
        .chart-filter-button.active {
            background-color: var(--brand-color);
            color: white;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.4);
            transform: translateY(-1px);
        }
        .chart-filter-button.active:hover {
            transform: translateY(-2px);
        }

        .update-notification {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            opacity: 0;
            padding: 0.75rem 1.5rem;
            background-color: var(--brand-color);
            color: white;
            border-radius: 9999px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.4s ease-in-out;
            z-index: 1000;
        }
        .update-notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        #password-overlay {
            background-color: var(--card-bg);
        }
        .password-form {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 12px 30px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }
        .password-form h2 {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .password-form input {
            padding: 0.75rem 1.25rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.75rem;
            width: 100%;
            max-width: 300px;
            transition: border-color 0.3s;
        }
        .password-form input:focus {
            outline: none;
            border-color: var(--brand-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        .password-form button {
            background-color: var(--brand-color);
            color: white;
            font-weight: 600;
            padding: 0.75rem 2rem;
            border-radius: 9999px;
            transition: all 0.3s;
        }
        .password-form button:hover {
            background-color: #4338ca;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(67, 56, 202, 0.4);
        }
    </style>
</head>
<body>
    <div id="password-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 z-[9999] flex items-center justify-center">
        <div class="password-form text-center">
            <h2 class="text-xl font-bold">DFLT Dashboard Access</h2>
            <img src="https://www.sdpi.org/assets/images/sdpi-logo-2020.webp" alt="SDPI Logo" class="h-16 w-auto">
            <input type="password" id="passwordInput" placeholder="Enter password" class="text-center" />
            <button id="submitPassword">Access Dashboard</button>
            <p id="passwordError" class="text-sm text-red-500 hidden">Incorrect password. Please try again.</p>
        </div>
    </div>
    
    <div id="welcome-overlay" class="welcome-overlay" style="display: none;">
        <img src="https://www.sdpi.org/assets/images/sdpi-logo-2020.webp" alt="SDPI Logo" class="h-24 w-auto mb-6 welcome-logo">
        <h1 class="welcome-text-1">Welcome to DFLT Phase 2 Dashboard</h1>
        <p class="welcome-text-2">Developed by Dr. Fareeha Armughan & Team</p>
    </div>

    <div id="update-notification" class="update-notification">
        <span class="font-semibold">Updating...</span> Dashboard is refreshing.
    </div>

    <div class="dashboard-grid" id="dashboard-content" style="display: none;">
        <header class="card header flex flex-row items-center justify-between">
            <div class="flex items-center gap-4">
                <img src="https://www.sdpi.org/assets/images/sdpi-logo-2020.webp" alt="SDPI Logo" class="h-16 w-auto">
            </div>

            <div class="flex items-center justify-center gap-6 flex-grow">
                <h1 class="text-xl font-extrabold text-gray-900 text-gradient-blue-purple">DFLT Phase-2 | Status Deck</h1>
                <div class="flex items-center gap-2">
                    <label for="provinceFilter" class="text-xs font-medium text-gray-600">Province:</label>
                    <select id="provinceFilter" class="block py-1 px-2 border border-gray-300 bg-gray-50 text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-accent-main focus:border-accent-main text-xs" onchange="updateDashboard()">
                        <option value="All">All Provinces</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <label for="District_Filter" class="text-xs font-medium text-gray-600">District:</label>
                    <select id="District_Filter" class="block py-1 px-2 border border-gray-300 bg-gray-50 text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-accent-main focus:border-accent-main text-xs" onchange="updateDashboard()">
                        <option value="All">All Districts</option>
                    </select>
                </div>
                <div class="text-right">
                    <p id="currentTime" class="font-bold text-gray-900 text-lg"></p>
                    <p id="currentDate" class="text-xs text-gray-600"></p>
                </div>
            </div>

            <img src="https://resume.brightspyre.com/affiliates/INTERACT%20Consulting/Giz%20pic-6493ec850de4e.png" alt="DFLT Logo" class="h-16 w-auto">
        </header>

        <div class="card map-card !p-1 relative">
            <div id="map"></div>
            <div class="absolute top-4 right-4 z-[1000]">
                <button id="toggleHeatmap" class="px-3 py-1 text-xs text-white bg-gray-800/80 hover:bg-gray-800 rounded-full shadow-lg backdrop-blur-sm transition-all duration-300">Toggle Heatmap</button>
            </div>
        </div>
        
        <div class="kpi-main">
            <div class="card justify-center">
                <h3 class="text-sm font-medium text-gray-600 flex items-center justify-between w-full">
                    <span>Total Beneficiaries Trained</span>
                    <span id="beneficiariesTargetPct" class="text-xs font-semibold text-teal-500">0%</span>
                </h3>
                <p id="totalBeneficiaries" class="text-4xl font-black text-indigo-600">0</p>
                <span class="text-xs text-gray-500 mt-2">Target: <span id="beneficiaryOverallTarget">0</span></span>
            </div>
            <div class="card justify-center">
                <h3 class="text-sm font-medium text-gray-600 flex items-center justify-between w-full">
                    <span>Total Trainings Conducted</span>
                    <span id="trainingsTargetPct" class="text-xs font-semibold text-emerald-500">0%</span>
                </h3>
                <p id="totalTrainings" class="text-4xl font-black text-indigo-600">0</p>
                <span class="text-xs text-gray-500 mt-2">Target: <span id="trainingOverallTarget">0</span></span>
            </div>
            <div class="card justify-center col-span-1">
                <h3 class="text-sm font-medium text-gray-600">Top Performing Province</h3>
                <p id="topProvinceName" class="text-2xl font-black text-blue-600 mt-1">N/A</p>
                <p id="topProvincePct" class="text-xl font-bold text-blue-500 mt-0">0% Target Achieved</p>
            </div>
        </div>

        <div class="card provincial-summary-card">
            <div class="flex items-center justify-between flex-shrink-0 mb-4">
                <h3 id="provincialSummaryTitle" class="text-md font-bold text-gray-800">Provincial Performance Overview</h3>
                <div class="flex items-center gap-2">
                    <label for="provincialCardFilter" class="text-xs font-medium text-gray-600">Filter:</label>
                    <select id="provincialCardFilter" class="block py-1 px-2 border border-gray-300 bg-gray-50 text-gray-900 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-xs"></select>
                </div>
            </div>
            <div id="provincialSummaryContent" class="flex-grow flex flex-col p-1">
                <p class="text-gray-500 text-sm text-center">Select a province to view its performance details.</p>
            </div>
        </div>

        <div class="card monthly-trend-card">
            <h3 class="text-md font-bold text-gray-800 flex-shrink-0">Beneficiaries Trend</h3>
            <div class="chart-filter-buttons">
                <button class="chart-filter-button" data-unit="month" data-metric="Beneficiary_Count_Actual">Monthly</button>
                <button class="chart-filter-button active" data-unit="day" data-metric="Beneficiary_Count_Actual">Daily</button>
            </div>
            <div class="chart-container"><canvas id="monthlyTrendChart"></canvas></div>
        </div>

        <div class="card provincial-ranking-card">
            <h3 class="text-md font-bold text-gray-800 flex-shrink-0">Provincial Ranking</h3>
            <div class="flex gap-2 mb-2">
                <button class="chart-filter-button active" data-sort-metric="beneficiaries">By Beneficiaries</button>
                <button class="chart-filter-button" data-sort-metric="trainings">By Trainings</button>
                <button class="chart-filter-button" data-sort-metric="target_achievement">By Target %</button>
                <button class="chart-filter-button" data-sort-metric="district">By District</button>
            </div>
            <div class="table-container mt-2">
                <table id="rankingTable" class="w-full text-left text-sm">
                    <thead class="text-xs text-gray-600 uppercase bg-gray-100">
                        <tr>
                            <th class="px-4 py-2">Rank</th>
                            <th class="px-4 py-2">Province</th>
                            <th class="px-4 py-2">Beneficiaries</th>
                            <th class="px-4 py-2">Trainings</th>
                            <th class="px-4 py-2">Target %</th>
                        </tr>
                    </thead>
                    <tbody id="provincialRankingTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="card leaderboard-card">
            <h3 class="text-md font-bold text-gray-800 flex-shrink-0">Top Trainers (Monthly Ranking)</h3>
            <div class="table-container mt-2">
                <table class="w-full text-left text-sm">
                    <thead class="text-xs text-gray-600 uppercase bg-gray-100">
                        <tr>
                            <th class="px-4 py-2">Rank</th>
                            <th class="px-4 py-2">Trainer</th>
                            <th class="px-4 py-2">Beneficiaries</th>
                            <th class="px-4 py-2">Target %</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let trainingData = [];
        let dashboardMetadata = {};
        let provinceDataSummary = {};
        let aggregatedMonthlyTrendData = {};
        let aggregatedDailyTrendData = {};
        let provincialRankingsData = [];
        let leaderboardData = [];
        let districtDataSummary = {};

        let occupationsHorizontalBarChart;
        let monthlyTrendChart;
        let ageDistributionChart;

        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTakZtvQeYjOMxvYbL91Ar8L99Ej3t2hZw2xJjFSqg0HLbaWrVyI7-bc4sS9A4RO4pgCH365J2OcRLt/pub?gid=317105383&single=true&output=csv';
        const TOTAL_PROJECT_TARGET_BENEFICIARIES = 280000;
        const MONTHLY_TARGET_PER_TRAINER = 256;
        const PASSWORD = "DFLT_2025!";

        let globalTargets = {
            provinces: {
                "Punjab": {target_beneficiaries: 105000, target_trainings: 600},
                "Sindh": {target_beneficiaries: 60000, target_trainings: 400},
                "Khyber Pakhtunkhwa": {target_beneficiaries: 65000, target_trainings: 250},
                "Balochistan": {target_beneficiaries: 20000, target_trainings: 150},
                "Gilgit-Baltistan": {target_beneficiaries: 10000, target_trainings: 80},
                "Azad Jammu & Kashmir": {target_beneficiaries: 15000, target_trainings: 100},
                "Islamabad Capital Territory": {target_beneficiaries: 5000, target_trainings: 40}
            }
        };

        const provinceColors = {
            "Punjab": "#22c55e", "Sindh": "#3b82f6", "Khyber Pakhtunkhwa": "#f97316", "Balochistan": "#ef4444",
            "Gilgit-Baltistan": "#a855f7", "Azad Jammu & Kashmir": "#06b6d4", "Islamabad Capital Territory": "#facc15"
        };
        const ageColors = {
            '18-29': '#3b82f6', '30-39': '#10b981', '40-49': '#f59e0b', '50-59': '#ef4444', '60+': '#a855f7', 'Unknown': '#64748b'
        };
        let map, markers, heatLayer;

        async function loadDataAndInitialize() {
            try {
                const response = await fetch(`${GOOGLE_SHEET_CSV_URL}&t=${new Date().getTime()}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch data from Google Sheets.');
                }
                const rawCsv = await response.text();
                
                const processedData = processCSVData(rawCsv);
                trainingData = processedData.dashboard_data;
                dashboardMetadata = processedData.metadata;
                
                if (!trainingData || trainingData.length === 0) {
                    throw new Error("Dashboard data is missing or empty after processing.");
                }
                
                preProcessAllData(trainingData);
                populateFilters(trainingData);
                initializeMap();
                initializeCharts();
                updateDashboard();

                setupEventListeners();
                
            } catch (error) {
                console.error(error);
                const updateNotification = document.getElementById('update-notification');
                updateNotification.textContent = "Error loading data. Reloading...";
                updateNotification.classList.add('show');
                setTimeout(() => location.reload(), 3000);
            }
        }
        
        function processCSVData(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const dataRows = lines.slice(1).map(line => {
                const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, ''));
                const row = {};
                headers.forEach((header, i) => {
                    row[header] = values[i] || '';
                });
                return row;
            });

            const day1Data = dataRows.filter(row => row.main_menu === 'day1');
            const day2Data = dataRows.filter(row => row.main_menu === 'day2');

            const day2Attendance = new Map();
            day2Data.forEach(row => {
                const sessionId = row.day2_session_select;
                if (sessionId) {
                    const cnicList = new Set(row.beneficiaries_present.split(' ').filter(c => c.trim() !== '').map(c => c.replace(/-/g, '')));
                    day2Attendance.set(sessionId, cnicList);
                }
            });

            const dashboardRecords = [];
            const sessionsMap = new Map();
            
            day1Data.forEach(row => {
                const sessionId = row.session_id;
                if (!sessionId) return;
                
                if (!sessionsMap.has(sessionId)) {
                    sessionsMap.set(sessionId, {
                        ...row,
                        beneficiaries: [],
                        female_occupations: {}
                    });
                }
                
                for (let i = 1; i <= 36; i++) {
                    const cnicCol = `beneficiary_cnic_${i}`;
                    const nameCol = `beneficiary_name_${i}`;
                    const occupationCol = `occupation_${i}`;
                    const ageCol = `age_${i}`;

                    const cnic = row[cnicCol];
                    const name = row[nameCol];
                    const occupation = row[occupationCol];
                    const age = row[ageCol];

                    if (cnic) {
                        const standardizedCnic = cnic.replace(/[^0-9]/g, '');
                        const hasAttendedDay2 = day2Attendance.get(sessionId)?.has(standardizedCnic) || false;
                        
                        sessionsMap.get(sessionId).beneficiaries.push({
                            cnic: standardizedCnic,
                            name: name,
                            occupation: occupation,
                            age: parseInt(age, 10) || null,
                            attended_day2: hasAttendedDay2
                        });
                        
                        if (occupation) {
                            sessionsMap.get(sessionId).female_occupations[occupation] = (sessionsMap.get(sessionId).female_occupations[occupation] || 0) + 1;
                        }
                    }
                }
            });

            sessionsMap.forEach(session => {
                const beneficiaryCount = session.beneficiaries.length;
                
                const attendedDay2Count = session.beneficiaries.filter(b => b.attended_day2).length;
                const retentionRate = beneficiaryCount > 0 ? (attendedDay2Count / beneficiaryCount) * 100 : 0;
                
                let trainerName = session.session_id.split(' ')[0] || session.lead_trainer_name;

                let avgTrainingTimeHours = 0;
                try {
                    const startTime = new Date(`1970-01-01T${session.start.match(/\d{2}:\d{2}:\d{2}/)[0]}`);
                    const endTime = new Date(`1970-01-01T${session.end.match(/\d{2}:\d{2}:\d{2}/)[0]}`);
                    const durationMs = endTime - startTime;
                    avgTrainingTimeHours = durationMs / (1000 * 60 * 60);
                } catch (e) {}

                const qualityScore = parseFloat(session.q_read_write || 0) + parseFloat(session.q_recognize_currency || 0) + parseFloat(session.q_simple_math || 0);
                const qualityIndex = qualityScore / 3;

                let lat = null, lon = null;
                const locationMatch = session.training_location.match(/(\-?\d+\.\d+)\s(\-?\d+\.\d+)/);
                if (locationMatch) {
                    lat = parseFloat(locationMatch[1]);
                    lon = parseFloat(locationMatch[2]);
                }
                
                dashboardRecords.push({
                    TrainingID: session.session_id,
                    Training_Date: session.SubmissionDate,
                    Province: session.province_select,
                    District: session.district_select,
                    ASPC_Name: trainerName,
                    Beneficiary_Count_Actual: beneficiaryCount,
                    Female_Beneficiaries: beneficiaryCount,
                    Retention_Rate_Pct: parseFloat(retentionRate.toFixed(2)),
                    Avg_Training_Time_Hours: parseFloat(avgTrainingTimeHours.toFixed(1)),
                    Female_Occupations: session.female_occupations,
                    Quality_Index: parseFloat(qualityIndex.toFixed(2)),
                    Start_Location_Lat: lat,
                    Start_Location_Lon: lon,
                    Beneficiaries_Details: session.beneficiaries
                });
            });

            return {
                dashboard_data: dashboardRecords,
                metadata: {
                    TOTAL_PROJECT_TARGET_BENEFICIARIES: TOTAL_PROJECT_TARGET_BENEFICIARIES,
                    MONTHLY_TARGET_PER_TRAINER: MONTHLY_TARGET_PER_TRAINER
                }
            };
        }
        
        function preProcessAllData(data) {
            provinceDataSummary = {};
            districtDataSummary = {};
            aggregatedMonthlyTrendData = {};
            aggregatedDailyTrendData = {};

            data.forEach(item => {
                const provinceName = item.Province;
                const trainingRetentionRate = item.Retention_Rate_Pct || 0;
                if (!provinceDataSummary[provinceName]) {
                    provinceDataSummary[provinceName] = {
                        trainings: 0, beneficiaries: 0, total_training_time: 0, total_retention_rate_sum: 0, total_quality_index: 0, item_count: 0, female_occupations: {},
                        age_distribution: { '18-29': 0, '30-39': 0, '40-49': 0, '50-59': 0, '60+': 0, 'Unknown': 0 }
                    };
                }
                provinceDataSummary[provinceName].trainings++;
                provinceDataSummary[provinceName].beneficiaries += item.Beneficiary_Count_Actual || 0;
                provinceDataSummary[provinceName].total_training_time += item.Avg_Training_Time_Hours || 0;
                provinceDataSummary[provinceName].total_retention_rate_sum += trainingRetentionRate;
                provinceDataSummary[provinceName].total_quality_index += item.Quality_Index || 0;
                provinceDataSummary[provinceName].item_count++;
                
                for (const occupation in item.Female_Occupations) {
                    provinceDataSummary[provinceName].female_occupations[occupation] = (provinceDataSummary[provinceName].female_occupations[occupation] || 0) + item.Female_Occupations[occupation];
                }

                if (item.Beneficiaries_Details) {
                    item.Beneficiaries_Details.forEach(beneficiary => {
                        const age = beneficiary.age;
                        if (age >= 18 && age <= 29) provinceDataSummary[provinceName].age_distribution['18-29']++;
                        else if (age >= 30 && age <= 39) provinceDataSummary[provinceName].age_distribution['30-39']++;
                        else if (age >= 40 && age <= 49) provinceDataSummary[provinceName].age_distribution['40-49']++;
                        else if (age >= 50 && age <= 59) provinceDataSummary[provinceName].age_distribution['50-59']++;
                        else if (age >= 60) provinceDataSummary[provinceName].age_distribution['60+']++;
                        else provinceDataSummary[provinceName].age_distribution['Unknown']++;
                    });
                }

                const districtName = item.District;
                if (!districtDataSummary[districtName]) {
                    districtDataSummary[districtName] = { trainings: 0, beneficiaries: 0 };
                }
                districtDataSummary[districtName].trainings++;
                districtDataSummary[districtName].beneficiaries += item.Beneficiary_Count_Actual || 0;

                const date = new Date(item.Training_Date);
                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-01`;
                const dayKey = date.toISOString().split('T')[0];
                
                aggregatedMonthlyTrendData[monthKey] = (aggregatedMonthlyTrendData[monthKey] || 0) + (item.Beneficiary_Count_Actual || 0);
                aggregatedDailyTrendData[dayKey] = (aggregatedDailyTrendData[dayKey] || 0) + (item.Beneficiary_Count_Actual || 0);
            });

            for (const pName in provinceDataSummary) {
                const summary = provinceDataSummary[pName];
                summary.avg_retention_rate = summary.item_count > 0 ? (summary.total_retention_rate_sum / summary.item_count) : 0;
                summary.avg_quality_index = summary.item_count > 0 ? (summary.total_quality_index / summary.item_count) : 0;
                summary.avg_training_time = summary.item_count > 0 ? (summary.total_training_time / summary.item_count) : 0;
            }

            const provincialPerformance = {};
            for (const pName in globalTargets.provinces) {
                provincialPerformance[pName] = {
                    beneficiaries: 0, trainings: 0,
                    target_beneficiaries: globalTargets.provinces[pName].target_beneficiaries,
                    target_trainings: globalTargets.provinces[pName].target_trainings
                };
            }
            data.forEach(item => {
                const provinceName = item.Province;
                if (provincialPerformance[provinceName]) {
                    provincialPerformance[provinceName].beneficiaries += (item.Beneficiary_Count_Actual || 0);
                    provincialPerformance[provinceName].trainings++;
                }
            });
            provincialRankingsData = Object.entries(provincialPerformance).map(([provinceName, stats]) => {
                const beneficiaryTargetPct = stats.target_beneficiaries > 0 ? (stats.beneficiaries / stats.target_beneficiaries) * 100 : 0;
                return {
                    province: provinceName, beneficiaries: stats.beneficiaries, trainings: stats.trainings,
                    beneficiary_target_pct: beneficiaryTargetPct, training_target_pct: stats.target_trainings
                };
            });

            const now = new Date();
            const monthlyData = data.filter(item => {
                const trainingDate = new Date(item.Training_Date);
                return trainingDate.getMonth() === now.getMonth() && trainingDate.getFullYear() === now.getFullYear();
            });
            const trainerPerformance = monthlyData.reduce((acc, item) => {
                const trainerName = item.ASPC_Name;
                const districtName = item.District;
                if (trainerName) {
                    if (!acc[trainerName]) acc[trainerName] = { beneficiaries: 0, trainings: 0, district: districtName };
                    acc[trainerName].beneficiaries += (item.Beneficiary_Count_Actual || 0);
                    acc[trainerName].trainings++;
                }
                return acc;
            }, {});
            leaderboardData = Object.entries(trainerPerformance).map(([name, stats]) => {
                const percent = Math.min(100, Math.round((stats.beneficiaries / MONTHLY_TARGET_PER_TRAINER) * 100));
                return { name, beneficiaries: stats.beneficiaries, target_pct: percent, district: stats.district };
            }).sort((a, b) => b.beneficiaries - a.beneficiaries).slice(0, 5);
        }

        function setupEventListeners() {
            document.querySelectorAll('.provincial-ranking-card .chart-filter-button').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.provincial-ranking-card .chart-filter-button').forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    updateProvincialRanking();
                });
            });

            document.querySelectorAll('.monthly-trend-card .chart-filter-buttons .chart-filter-button').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.monthly-trend-card .chart-filter-buttons .chart-filter-button').forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    const filteredData = trainingData.filter(item => document.getElementById('provinceFilter').value === 'All' || item.Province === document.getElementById('provinceFilter').value);
                    updateMonthlyTrendChart(filteredData, button.dataset.unit, button.dataset.metric);
                });
            });

            document.getElementById('map').addEventListener('click', (event) => {
                let targetElement = event.target;
                while (targetElement && targetElement !== this && !targetElement.dataset.provinceName) {
                    targetElement = targetElement.parentNode;
                }
                if (targetElement && targetElement.dataset.provinceName) {
                    const provinceName = targetElement.dataset.provinceName;
                    document.getElementById('provinceFilter').value = provinceName;
                    updateDashboard();
                } else {
                    document.getElementById('provinceFilter').value = 'All';
                    updateDashboard();
                }
            });
            document.getElementById('toggleHeatmap').addEventListener('click', toggleHeatmap);
        }
        
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        }

        function populateFilters(data) {
            const provinceFilter = document.getElementById('provinceFilter');
            const districtFilter = document.getElementById('District_Filter');
            const provincialCardFilter = document.getElementById('provincialCardFilter');

            const uniqueProvinces = [...new Set(data.map(item => item.Province).filter(Boolean))].sort();
            const uniqueDistricts = [...new Set(data.map(item => item.District).filter(Boolean))].sort();

            provinceFilter.innerHTML = '<option value="All">All Provinces</option>';
            provincialCardFilter.innerHTML = '';
            uniqueProvinces.forEach(p => {
                provinceFilter.add(new Option(p, p));
                provincialCardFilter.add(new Option(p, p));
            });

            districtFilter.innerHTML = '<option value="All">All Districts</option>';
            uniqueDistricts.forEach(d => {
                districtFilter.add(new Option(d, d));
            });
            provinceFilter.value = 'Punjab';
            provincialCardFilter.value = 'Punjab';
        }

        function initializeMap() {
            if(map) map.remove();
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([30.3753, 69.3451], 5.5);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a>'
            }).addTo(map);

            markers = L.featureGroup().addTo(map);
            heatLayer = L.heatLayer([], {
                radius: 25, blur: 15, maxZoom: 10,
                gradient: { 0.4: '#60a5fa', 0.65: '#2dd4bf', 1: '#ef4444' }
            });
        }

        function toggleHeatmap() {
            if (map.hasLayer(heatLayer)) {
                map.removeLayer(heatLayer);
                map.addLayer(markers);
            } else {
                map.removeLayer(markers);
                map.addLayer(heatLayer);
            }
        }

        function updateDashboard() {
            const provinceFilterValue = document.getElementById('provinceFilter').value;
            const districtFilterValue = document.getElementById('District_Filter').value;
            
            let filteredData = trainingData.filter(item => {
                const provinceMatch = provinceFilterValue === 'All' || item.Province === provinceFilterValue;
                const districtMatch = districtFilterValue === 'All' || item.District === districtFilterValue;
                return provinceMatch && districtMatch;
            });

            updateKPIs(filteredData, provinceFilterValue);
            updateMapAndHeatmap(filteredData);
            updateLeaderboard();
            updateProvincialRanking();

            const activeUnitButton = document.querySelector('.monthly-trend-card .chart-filter-buttons .active');
            const currentUnit = activeUnitButton ? activeUnitButton.dataset.unit : 'day';
            const currentMetric = activeUnitButton ? activeUnitButton.dataset.metric : 'Beneficiary_Count_Actual';
            updateMonthlyTrendChart(filteredData, currentUnit, currentMetric);

            document.getElementById('provincialCardFilter').value = provinceFilterValue;
            updateProvincialSummaryContent(provinceFilterValue);
            
            document.querySelectorAll('#pakistan-map-svg path, #pakistan-map-svg circle').forEach(path => path.classList.remove('selected'));
            if (provinceFilterValue !== 'All') {
                const svgProvinceElement = document.querySelector(`#pakistan-map-svg [data-province-name="${provinceFilterValue}"]`);
                if (svgProvinceElement) {
                    svgProvinceElement.classList.add('selected');
                }
            }
        }

        function animateValue(obj, start, end, duration, isPercent = false) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const value = Math.floor(start + progress * (end - start));
                obj.innerHTML = value.toLocaleString() + (isPercent ? '%' : '');
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        function updateKPIs(data, currentFilterProvince) {
            const totalBeneficiaries = data.reduce((s, i) => s + (i.Beneficiary_Count_Actual || 0), 0);
            const totalTrainings = data.length;

            let overallBeneficiaryTarget = 0;
            let overallTrainingTarget = 0;

            if (currentFilterProvince === 'All') {
                overallBeneficiaryTarget = TOTAL_PROJECT_TARGET_BENEFICIARIES;
                overallTrainingTarget = Object.values(globalTargets.provinces).reduce((sum, p) => sum + p.target_trainings, 0);
            } else {
                const provinceData = globalTargets.provinces[currentFilterProvince];
                overallBeneficiaryTarget = provinceData ? provinceData.target_beneficiaries : 0;
                overallTrainingTarget = provinceData ? provinceData.target_trainings : 0;
            }
            
            const beneficiariesTargetPct = overallBeneficiaryTarget > 0 ? ((totalBeneficiaries / overallBeneficiaryTarget) * 100).toFixed(1) : '0';
            const trainingsTargetPct = overallTrainingTarget > 0 ? ((totalTrainings / overallTrainingTarget) * 100).toFixed(1) : '0';

            animateValue(document.getElementById('totalBeneficiaries'), parseInt(document.getElementById('totalBeneficiaries').textContent.replace(/,/g, '') || '0'), totalBeneficiaries, 1000);
            document.getElementById('beneficiariesTargetPct').textContent = `${beneficiariesTargetPct}% Target`;
            document.getElementById('beneficiaryOverallTarget').textContent = overallBeneficiaryTarget.toLocaleString();

            animateValue(document.getElementById('totalTrainings'), parseInt(document.getElementById('totalTrainings').textContent.replace(/,/g, '') || '0'), totalTrainings, 1000);
            document.getElementById('trainingsTargetPct').textContent = `${trainingsTargetPct}% Target`;
            document.getElementById('trainingOverallTarget').textContent = overallTrainingTarget.toLocaleString();

            let topProvince = null;
            let maxProvinceAchievedPct = -1;

            for (const pName in globalTargets.provinces) {
                const summarizedProvince = provinceDataSummary[pName];
                if (summarizedProvince) {
                    const currentBeneficiaries = summarizedProvince.beneficiaries;
                    const provinceTarget = globalTargets.provinces[pName].target_beneficiaries;
                    const achievedPct = provinceTarget > 0 ? (currentBeneficiaries / provinceTarget) * 100 : 0;
                    if (achievedPct > maxProvinceAchievedPct) {
                        maxProvinceAchievedPct = achievedPct;
                        topProvince = pName;
                    }
                }
            }
            document.getElementById('topProvinceName').textContent = topProvince || 'N/A';
            document.getElementById('topProvincePct').textContent = `${maxProvinceAchievedPct.toFixed(1)}% Target Achieved`;
        }
        
        function updateMapAndHeatmap(data) {
            markers.clearLayers();
            const heatPoints = [];
            const maxBeneficiaryCount = Math.max(...data.map(item => item.Beneficiary_Count_Actual || 0), 1);
            data.forEach(item => {
                const lat = parseFloat(item.Start_Location_Lat);
                const lon = parseFloat(item.Start_Location_Lon);
                if (!isNaN(lat) && !isNaN(lon)) {
                    const latLng = [lat, lon];
                    heatPoints.push([...latLng, (item.Beneficiary_Count_Actual || 0) / maxBeneficiaryCount]);
                    const markerSize = 14 + ((item.Beneficiary_Count_Actual || 0) / maxBeneficiaryCount) * 20;
                    const markerIcon = L.divIcon({
                        html: `<div style="position: relative; display: flex; align-items: center; justify-content: center;"><div class="location-dot-pulse" style="width:${markerSize*1.5}px; height:${markerSize*1.5}px; background-color:${provinceColors[item.Province] || '#4f46e5'}1A;"></div><div class="location-dot" style="width:${markerSize}px; height:${markerSize}px; background-color:${provinceColors[item.Province] || '#4f46e5'};"><svg viewBox="0 0 24 24" fill="white" width="${markerSize*0.6}" height="${markerSize*0.6}"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z"/></svg></div></div>`,
                        className: 'leaflet-div-icon',
                        iconSize: [markerSize * 1.5, markerSize * 1.5],
                        iconAnchor: [markerSize * 0.75, markerSize * 0.75]
                    });
                    L.marker(latLng, { icon: markerIcon }).bindPopup(`
                        <div style="font-family: 'Montserrat', sans-serif; color: #1f2937;">
                            <div class="font-bold text-base mb-1">${item.ASPC_Name || 'N/A'}</div>
                            <div class="text-xs text-gray-600 mb-2">Training ID: ${item.TrainingID || 'N/A'}</div>
                            <div class="text-sm text-gray-700"><strong>Beneficiaries:</strong> <span class="text-indigo-600 font-bold">${item.Beneficiary_Count_Actual || 0}</span></div>
                            <div class="text-sm text-gray-700"><strong>Training Date:</strong> ${item.Training_Date || 'N/A'}</div>
                            <div class="text-xs text-gray-500 mt-2">in ${item.District || 'N/A'}, ${item.Province || 'N/A'}</div>
                        </div>`, { maxWidth: 250 }).addTo(markers);
                }
            });
            heatLayer.setLatLngs(heatPoints);
            if (markers.getLayers().length > 0) {
                map.fitBounds(markers.getBounds().pad(0.1));
            } else {
                map.setView([30.3753, 69.3451], 5.5);
            }
        }
        
        function updateProvincialSummaryContent(selectedProvinceName) {
            const provincialSummaryContent = document.getElementById('provincialSummaryContent');
            const provincialSummaryTitle = document.getElementById('provincialSummaryTitle');
            const provinceData = provinceDataSummary[selectedProvinceName];
            
            provincialSummaryTitle.textContent = `Provincial Performance Overview for ${selectedProvinceName}`;
            
            if (!provinceData || selectedProvinceName === 'All' || selectedProvinceName === 'Select Province') {
                provincialSummaryContent.innerHTML = `<p class="text-gray-500 text-sm text-center">Select a province to view its performance details.</p>`;
                if (occupationsHorizontalBarChart) occupationsHorizontalBarChart.destroy();
                if (ageDistributionChart) ageDistributionChart.destroy();
                return;
            }

            const occupationLabels = Object.keys(provinceData.female_occupations);
            const occupationData = Object.values(provinceData.female_occupations);
            const totalOccupations = occupationData.reduce((sum, val) => sum + val, 0);

            provincialSummaryContent.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-100 p-4 rounded-lg shadow-sm">
                        <h4 class="text-sm font-medium text-gray-600">Total Beneficiaries</h4>
                        <p class="text-2xl font-bold text-indigo-600">${(provinceData.beneficiaries || 0).toLocaleString()}</p>
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg shadow-sm">
                        <h4 class="text-sm font-medium text-gray-600">Total Trainings</h4>
                        <p class="text-2xl font-bold text-teal-600">${(provinceData.trainings || 0).toLocaleString()}</p>
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg shadow-sm">
                        <h4 class="text-sm font-medium text-gray-600">Avg. Retention Rate</h4>
                        <p class="text-2xl font-bold text-yellow-600">${(provinceData.avg_retention_rate || 0).toFixed(1)}%</p>
                    </div>
                    <div class="bg-gray-100 p-4 rounded-lg shadow-sm">
                        <h4 class="text-sm font-medium text-gray-600">Avg. Quality Index</h4>
                        <p class="text-2xl font-bold text-blue-600">${(provinceData.avg_quality_index || 0).toFixed(2)}</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-2 gap-4 mt-4 flex-grow">
                    <div class="p-4 bg-white rounded-lg shadow-inner flex flex-col min-h-[250px]">
                        <h4 class="text-md font-bold text-gray-800 mb-2 flex-shrink-0">Top Occupations</h4>
                        <div class="chart-container h-full w-full flex-grow flex items-center justify-center">
                            ${totalOccupations > 0 ? '<canvas id="occupationsHorizontalBarChart"></canvas>' : '<p class="text-gray-500 text-sm text-center">No occupation data.</p>'}
                        </div>
                    </div>
                    <div class="p-4 bg-white rounded-lg shadow-inner flex flex-col min-h-[250px]">
                        <h4 class="text-md font-bold text-gray-800 mb-2 flex-shrink-0">Beneficiary Age Distribution</h4>
                        <div class="chart-container h-full w-full flex-grow flex items-center justify-center">
                            ${provinceData.beneficiaries > 0 ? '<canvas id="ageDistributionChart"></canvas>' : '<p class="text-gray-500 text-sm text-center">No age data.</p>'}
                        </div>
                    </div>
                </div>
            `;
            if (totalOccupations > 0) {
                renderOccupationsHorizontalBarChart(occupationLabels, occupationData);
            }
             if (provinceData.beneficiaries > 0) {
                renderAgeDistributionChart(provinceData.age_distribution);
            }
        }
        
        function renderOccupationsHorizontalBarChart(labels, data) {
            const ctx = document.getElementById('occupationsHorizontalBarChart').getContext('2d');
            if (occupationsHorizontalBarChart) {
                occupationsHorizontalBarChart.destroy();
            }
            occupationsHorizontalBarChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Beneficiaries',
                        data: data,
                        backgroundColor: [
                            '#4c51bf', '#48bb78', '#f6ad55', '#e53e3e', '#805ad5',
                            '#38b2ac', '#4299e1', '#d53f8c', '#ecc94b', '#f7fafc'
                        ],
                        borderColor: [
                             '#3b3b8c', '#389e67', '#c28532', '#c53030', '#6b46c1',
                             '#2c7a7b', '#2b6cb0', '#a02b66', '#a78b3f', '#e2e8f0'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: { beginAtZero: true },
                        y: { ticks: { font: { family: 'Montserrat' } } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { titleFont: { family: 'Montserrat' }, bodyFont: { family: 'Montserrat' } }
                    }
                }
            });
        }
        
        function renderAgeDistributionChart(ageData) {
            const ctx = document.getElementById('ageDistributionChart').getContext('2d');
            if (ageDistributionChart) {
                ageDistributionChart.destroy();
            }
            const labels = Object.keys(ageData);
            const data = Object.values(ageData);

            ageDistributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Beneficiaries by Age Group',
                        data: data,
                        backgroundColor: Object.values(ageColors),
                        borderColor: Object.values(ageColors).map(c => c.replace('0.6)', '1)')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: {
                                color: '#1a202c',
                                font: { family: 'Montserrat' },
                                maxRotation: 45,
                                minRotation: 45,
                            },
                            grid: { display: false }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: '#e2e8f0' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    }
                }
            });
        }

        function initializeCharts() {
            const ticksColor = '#212529', gridColor = '#e5e7eb';
            const defaultOptions = {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        titleFont: { family: 'Montserrat' },
                        bodyFont: { family: 'Montserrat' }
                    },
                    annotation: {
                        annotations: {
                            targetLine: {
                                type: 'line', yScaleID: 'y', value: 0, borderColor: '#ef4444',
                                borderWidth: 2, borderDash: [6, 6],
                                label: {
                                    content: 'Target', enabled: true, position: 'end',
                                    color: '#ef4444', font: { family: 'Montserrat', size: 10 }
                                }
                            }
                        }
                    }
                },
                scales: {
                    x: { ticks: { color: ticksColor, font: { family: 'Montserrat' } }, grid: { color: gridColor } },
                    y: { beginAtZero: true, ticks: { color: ticksColor, font: { family: 'Montserrat' } }, grid: { color: gridColor } }
                }
            };
            
            const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
            monthlyTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        data: [], borderWidth: 2, tension: 0.4, pointRadius: 3, pointBackgroundColor: '#4f46e5', borderColor: '#4f46e5', fill: true,
                        backgroundColor: (context) => {
                            const {ctx, chartArea} = context.chart;
                            if (!chartArea) return null;
                            const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                            gradient.addColorStop(0, 'rgba(79, 70, 229, 0)');
                            gradient.addColorStop(1, 'rgba(79, 70, 229, 0.4)');
                            return gradient;
                        }
                    }]
                },
                options: {
                    ...defaultOptions,
                    scales: {
                        x: { type: 'time', time: { unit: 'day' }, ticks: { color: ticksColor, font: { family: 'Montserrat' } }, grid: { color: gridColor } },
                        y: { beginAtZero: true, ticks: { color: ticksColor, font: { family: 'Montserrat' } }, grid: { color: gridColor } }
                    }
                }
            });
        }

        function updateMonthlyTrendChart(filteredData, unit = 'day', metric = 'Beneficiary_Count_Actual') {
            let filteredAggregatedData = {};
            
            filteredData.forEach(item => {
                const date = new Date(item.Training_Date);
                const key = (unit === 'day') ? date.toISOString().split('T')[0] : `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-01`;
                filteredAggregatedData[key] = (filteredAggregatedData[key] || 0) + (item[metric] || 0);
            });

            const sortedKeys = Object.keys(filteredAggregatedData).sort();
            const labels = sortedKeys.map(key => new Date(key));
            const values = sortedKeys.map(key => filteredAggregatedData[key]);
            
            monthlyTrendChart.data.labels = labels;
            monthlyTrendChart.data.datasets[0].data = values;
            monthlyTrendChart.options.scales.x.time.unit = unit;
            
            let currentTargetValue = (unit === 'day') ? (TOTAL_PROJECT_TARGET_BENEFICIARIES / Object.keys(provinceDataSummary).length) / 30.4 : (TOTAL_PROJECT_TARGET_BENEFICIARIES / Object.keys(provinceDataSummary).length);
            monthlyTrendChart.options.plugins.annotation.annotations.targetLine.value = currentTargetValue;
            monthlyTrendChart.options.plugins.annotation.annotations.targetLine.label.content = `Target: ${currentTargetValue.toFixed(0)}`;
            
            monthlyTrendChart.update();
        }

        function updateProvincialRanking() {
            const activeSortButton = document.querySelector('.provincial-ranking-card .flex.gap-2 .chart-filter-button.active');
            const sortMetric = activeSortButton ? activeSortButton.dataset.sortMetric : 'beneficiaries';
            const tableBody = document.getElementById('provincialRankingTableBody');
            const rankingTable = document.getElementById('rankingTable');

            let sortedData = [];
            let tableHeaderHTML = '';

            if (sortMetric === 'beneficiaries' || sortMetric === 'trainings' || sortMetric === 'target_achievement') {
                 if (sortMetric === 'beneficiaries') sortedData = [...provincialRankingsData].sort((a, b) => b.beneficiaries - a.beneficiaries);
                 if (sortMetric === 'trainings') sortedData = [...provincialRankingsData].sort((a, b) => b.trainings - a.trainings);
                 if (sortMetric === 'target_achievement') sortedData = [...provincialRankingsData].sort((a, b) => b.beneficiary_target_pct - a.beneficiary_target_pct);

                tableHeaderHTML = `<tr><th class="px-4 py-2">Rank</th><th class="px-4 py-2">Province</th><th class="px-4 py-2">Beneficiaries</th><th class="px-4 py-2">Trainings</th><th class="px-4 py-2">Target %</th></tr>`;
                tableBody.innerHTML = sortedData.map((item, index) => {
                    const targetPercentColor = item.beneficiary_target_pct >= 80 ? 'bg-green-500' : (item.beneficiary_target_pct >= 50 ? 'bg-yellow-500' : 'bg-red-500');
                    return `<tr class="border-b border-gray-200">
                                <td class="px-4 py-2 font-medium text-gray-800">${index + 1}</td>
                                <td class="px-4 py-2 text-gray-700">${item.province}</td>
                                <td class="px-4 py-2 text-gray-700">${(item.beneficiaries || 0).toLocaleString()}</td>
                                <td class="px-4 py-2 text-gray-700">${(item.trainings || 0).toLocaleString()}</td>
                                <td class="px-4 py-2 text-gray-700">
                                    <div class="w-full bg-gray-300 rounded-full h-2.5">
                                        <div class="${targetPercentColor} h-2.5 rounded-full" style="width: ${Math.min(100, item.beneficiary_target_pct)}%"></div>
                                    </div>
                                    <span class="text-xs text-gray-600">${(item.beneficiary_target_pct || 0).toFixed(1)}%</span>
                                </td>
                            </tr>`;
                }).join('');
            } else if (sortMetric === 'district') {
                const sortedDistricts = Object.entries(districtDataSummary).map(([name, stats]) => ({
                    name, trainings: stats.trainings, beneficiaries: stats.beneficiaries
                })).sort((a, b) => b.trainings - a.trainings);
                
                tableHeaderHTML = `<tr><th class="px-4 py-2">Rank</th><th class="px-4 py-2">District</th><th class="px-4 py-2">Trainings</th><th class="px-4 py-2">Beneficiaries</th></tr>`;
                tableBody.innerHTML = sortedDistricts.map((item, index) => `
                    <tr class="border-b border-gray-200">
                        <td class="px-4 py-2 font-medium text-gray-800">${index + 1}</td>
                        <td class="px-4 py-2 text-gray-700">${item.name}</td>
                        <td class="px-4 py-2 text-gray-700">${(item.trainings || 0).toLocaleString()}</td>
                        <td class="px-4 py-2 text-gray-700">${(item.beneficiaries || 0).toLocaleString()}</td>
                    </tr>`).join('');
            }

            rankingTable.querySelector('thead').innerHTML = tableHeaderHTML;

            if ((sortMetric !== 'district' && sortedData.length === 0) || (sortMetric === 'district' && Object.keys(districtDataSummary).length === 0)) {
                const colspan = sortMetric === 'district' ? 4 : 5;
                tableBody.innerHTML = `<tr><td colspan="${colspan}" class="px-4 py-2 text-center text-gray-500">No data available.</td></tr>`;
            }
        }
        
        function updateLeaderboard() {
            const sortedTrainers = leaderboardData;
            const tableBody = document.getElementById('leaderboardTableBody');
            tableBody.innerHTML = '';
            if (sortedTrainers.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="px-4 py-2 text-center text-gray-500">No trainer data this month.</td></tr>`;
            } else {
                sortedTrainers.forEach((item, index) => {
                    const targetPercentColor = item.target_pct >= 80 ? 'bg-green-500' : (item.target_pct >= 50 ? 'bg-yellow-500' : 'bg-red-500');
                    tableBody.innerHTML += `
                        <tr class="border-b border-gray-200">
                            <td class="px-4 py-2 font-medium text-gray-800">${index + 1}</td>
                            <td class="px-4 py-2 text-gray-700">${item.name} (${item.district})</td>
                            <td class="px-4 py-2 text-gray-700">${(item.beneficiaries || 0).toLocaleString()}</td>
                            <td class="px-4 py-2 text-gray-700">
                                <div class="w-full bg-gray-300 rounded-full h-2.5">
                                    <div class="${targetPercentColor} h-2.5 rounded-full" style="width: ${item.target_pct}%"></div>
                                </div>
                                <span class="text-xs text-gray-600">${item.target_pct}%</span>
                            </td>
                        </tr>`;
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const dashboardContent = document.getElementById('dashboard-content');
            const passwordOverlay = document.getElementById('password-overlay');
            const welcomeOverlay = document.getElementById('welcome-overlay');
            const updateNotification = document.getElementById('update-notification');
            const passwordInput = document.getElementById('passwordInput');
            const submitPasswordBtn = document.getElementById('submitPassword');
            const passwordError = document.getElementById('passwordError');

            function startWelcomeAnimation() {
                passwordOverlay.style.display = 'none';
                welcomeOverlay.style.display = 'flex';

                setTimeout(() => {
                    welcomeOverlay.style.opacity = '0';
                    setTimeout(() => {
                        welcomeOverlay.style.display = 'none';
                        dashboardContent.style.display = 'grid';
                        initializeDashboardAndAutoUpdate();
                    }, 1000);
                }, 4000);
            }

            function initializeDashboardAndAutoUpdate() {
                async function refreshDashboard(isInitialLoad = false) {
                    if (!isInitialLoad) {
                        updateNotification.classList.add('show');
                    }
                    updateTime();
                    await loadDataAndInitialize();
                    if (!isInitialLoad) {
                        setTimeout(() => {
                            updateNotification.classList.remove('show');
                        }, 2000);
                    }
                }
                
                refreshDashboard(true);
                setInterval(() => refreshDashboard(false), 60000);
                setInterval(updateTime, 1000);
            }

            submitPasswordBtn.addEventListener('click', () => {
                if (passwordInput.value === PASSWORD) {
                    startWelcomeAnimation();
                } else {
                    passwordError.classList.remove('hidden');
                }
            });

            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitPasswordBtn.click();
                }
            });
        });
    </script>
</body>
</html>
